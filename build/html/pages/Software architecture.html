

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>2. Software architecture &mdash; H29 1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Superadmin profile" href="Superadmin profile.html" />
    <link rel="prev" title="Environments" href="Environments.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> H29
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">H29</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Environments.html">Environments</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">2. Software architecture</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#general-schema">2.1. General schema</a></li>
<li class="toctree-l2"><a class="reference internal" href="#level-1-system-context">2.2. Level 1: System Context</a></li>
<li class="toctree-l2"><a class="reference internal" href="#level-2-containers">2.3. Level 2: Containers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#level-3-component">2.4. Level 3: Component</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#webapp">2.4.1. Webapp</a></li>
<li class="toctree-l3"><a class="reference internal" href="#external-apis">2.4.2. External APIs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#azure-cognitive-services">2.4.3. Azure cognitive services</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#computer-vision">2.4.3.1. Computer Vision</a></li>
<li class="toctree-l4"><a class="reference internal" href="#qna-maker">2.4.3.2. Qna maker</a></li>
<li class="toctree-l4"><a class="reference internal" href="#translator">2.4.3.3. Translator</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#azure-healthbot">2.4.4. Azure healthbot</a></li>
<li class="toctree-l3"><a class="reference internal" href="#azure-blobs">2.4.5. Azure blobs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#databases">2.4.6. Databases</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#level-4-code">2.5. Level 4: Code</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">2.5.1. Webapp</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#communication">2.5.1.1. Communication</a></li>
<li class="toctree-l4"><a class="reference internal" href="#code-structure-client-structure">2.5.1.2. Code Structure: Client Structure</a></li>
<li class="toctree-l4"><a class="reference internal" href="#code-structure-server-structure">2.5.1.3. Code Structure: Server Structure</a></li>
<li class="toctree-l4"><a class="reference internal" href="#build">2.5.1.4. Build</a></li>
<li class="toctree-l4"><a class="reference internal" href="#deploy-environments">2.5.1.5. Deploy environments</a></li>
<li class="toctree-l4"><a class="reference internal" href="#external-libraries-and-dependencies">2.5.1.6. External libraries and dependencies</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id2">2.5.2. External APIs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">2.5.3. Azure cognitive services</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id4">2.5.3.1. Computer Vision</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">2.5.3.2. Qna maker</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">2.5.3.3. Translator</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id7">2.5.4. Azure Healthbot</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id8">2.5.5. Azure blobs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id9">2.5.6. Databases</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Superadmin profile.html">Superadmin profile</a></li>
<li class="toctree-l1"><a class="reference internal" href="Technical debt.html">Technical debt</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">H29</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>2. Software architecture</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/pages/Software architecture.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <img align="right" width="100px" src="../../../source/images/All//Foundation29.png"><div class="section" id="software-architecture">
<h1>2. Software architecture<a class="headerlink" href="#software-architecture" title="Permalink to this headline">¶</a></h1>
<div class="section" id="general-schema">
<h2>2.1. General schema<a class="headerlink" href="#general-schema" title="Permalink to this headline">¶</a></h2>
<p>We will use the C4 model to expose the software architecture. Thus, in the description of this section we will differentiate between:</p>
<ul class="simple">
<li><p>Level 1: A <strong>System Context</strong> diagram provides a starting point, showing how the software system in scope fits into the world around it.</p></li>
<li><p>Level 2: A <strong>Container</strong> diagram zooms into the software system in scope, showing the high-level technical building blocks.</p></li>
<li><p>Level 3: A <strong>Component</strong> diagram zooms into an individual container, showing the components inside it.</p></li>
<li><p>Level 4: A <strong>code</strong> (e.g. UML class) diagram can be used to zoom into an individual component, showing how that component is implemented.</p></li>
</ul>
<p><img alt="Alt" src="../_images/H29_C4model.png" /></p>
</div>
<hr class="docutils" />
<div class="section" id="level-1-system-context">
<h2>2.2. Level 1: System Context<a class="headerlink" href="#level-1-system-context" title="Permalink to this headline">¶</a></h2>
<p>************************TODO:</p>
<p>For Android and iOS apps, we use the cordova framework. When compiling the Angular project, it generates the dist folder, which is the one to be added to the www folder of the Corova project.  We were evaluating ionic, nativescript and reactscript, they would be good options if we were more people, but at the moment we fit more cordova.</p>
<p>Our idea is to migrate to FHIR, so we would have to modify our API to make calls to <a class="reference external" href="https://www.hl7.org/fhir/">FHIR’s API</a></p>
<p>Health29 provides a web API to access the data. Anyone can develop an application to access and modify the data of a Health29 user. OAuth 2.0 is used as an authorization protocol to give an API client limited access to the user’s data.</p>
</div>
<hr class="docutils" />
<div class="section" id="level-2-containers">
<h2>2.3. Level 2: Containers<a class="headerlink" href="#level-2-containers" title="Permalink to this headline">¶</a></h2>
<p>Health29 consists of several connected containers.
We have divided them according to their functionality and use within the platform.Thus, we will have:</p>
<ul class="simple">
<li><p>Webapp container.</p></li>
<li><p>External APIs container.</p></li>
<li><p>Azure cognitive services container.</p></li>
<li><p>Azure healthbot container.</p></li>
<li><p>Azure blobs container.</p></li>
<li><p>Databases container.</p></li>
</ul>
<p style="text-align: center;">
	<img width="500px" src="../../../source/images/Architecture/Containers/containersH29.jpg">
</p><p>These modules are intercommunicated using a <a class="reference external" href="https://restfulapi.net/">REST</a> interface, that is, the communication is established according to the <a class="reference external" href="https://restfulapi.net/http-methods/">HTTP protocol</a>.</p>
<p>In this way, it will be necessary to configure the different services you want to use so that communications can be established. To do this, during the implementation of the webapp the keys and the corresponding endpoint will be used to establish communication, and the sending of the REST commands will use specific authorization headers.</p>
<p>The most common headers we can find are:</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>Headers</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Ocp-Apim-Subscription-Key</td>
<td>Use with Cognitive Services subscription if you pass your secret key.</td>
</tr>
<tr>
<td>Authorization</td>
<td>Use with your Cognitive Services subscription if you pass an authentication token. The value is the bearer token: Bearer token_value</td>
</tr>
</tbody>
</table><p>The webapp will be the core of the Health29 application, from where the frontend will be developed and the communications with different services to provide functionalities.</p>
<p>Health29 is a clinical history application that will allow users to enter their medical data. Different Azure services will be used to carry out the relevant actions:</p>
<ul class="simple">
<li><p>External APIs that will be used as intermediaries between the webapp and Azure’s cognitive services. To add different functionalities to the application and thus simplify the development and implementation of the webapp.</p></li>
<li><p>Healthbot. The application will have a chatbot to help the user.</p></li>
<li><p>Azure blobs and databases. To store information.</p></li>
</ul>
</div>
<hr class="docutils" />
<div class="section" id="level-3-component">
<h2>2.4. Level 3: Component<a class="headerlink" href="#level-3-component" title="Permalink to this headline">¶</a></h2>
<p>Taking into account the division by containers exposed in the previous point, we are now going to study in detail the internal architecture and the components that make up each one of them.</p>
<div class="section" id="webapp">
<h3>2.4.1. Webapp<a class="headerlink" href="#webapp" title="Permalink to this headline">¶</a></h3>
<p>Health29’s architecture uses a client-server software design model, so that the architecture of the webapp is like:</p>
<p><img alt="Alt" src="../_images/Webapp.jpg" /></p>
<p>For the client we use the Angular 5 framework, and for the nodejs - express server, in which we have implemented an API to connect to the CosmoDb databases using mongoose for its management.</p>
<p><img alt="Alt" src="../_images/Webapp_frameworks_architecture.jpg" /></p>
<p>These modules are intercommunicated using a <a class="reference external" href="https://restfulapi.net/">REST</a> interface, that is, the communication is established according to the <a class="reference external" href="https://restfulapi.net/http-methods/">HTTP protocol</a>.</p>
<p>This communication between client and server is mainly used for data management, i.e. to obtain, add or modify information from databases.
For this purpose, an HTTP service will be used to allow, through requests from the client to the server, to carry out these operations. The server will listen to these requests and will perform the appropriate operations to give an answer to the client.</p>
<ul class="simple">
<li><p>Most requests to the API require an access token as authentication. For this, go to Get access_token</p></li>
<li><p>Once we have the access token, we can make the calls to the api, passing the access token in the header.</p></li>
</ul>
<p>All Methods APIs that have the authorization field in the header use Bearer authentication to restrict access to protected resources, , and always be sent next to a token. The bearer token is a cryptic string, generated by the server in response to a login request. Example of the header: Authorization: Bearer “token”</p>
<p>These requests can return some errors, such as the token is invalid, or has expired: { status: 401, message: “Token expired”} or { status: 401, message: “Invalid Token”}</p>
<p>As the client is implemented using the Angular 5 framework, when compiling it (<a class="reference external" href="https://angular.io/guide/deployment">ng build</a>) you will get a “/dist” folder that must be included in the server for the construction of the platform.</p>
</div>
<div class="section" id="external-apis">
<h3>2.4.2. External APIs<a class="headerlink" href="#external-apis" title="Permalink to this headline">¶</a></h3>
<p>We use two External APIs:</p>
<ul class="simple">
<li><p><em><a class="reference external" href="https://f29api.northeurope.cloudapp.azure.com/index.html">Foundation29 API</a></em>, implemented by us to use it as an intermediary between the webapp and the azure qnamaker service.</p></li>
<li><p>The <em><a class="reference external" href="https://api.monarchinitiative.org/">Monarch</a> API</em> .</p></li>
</ul>
<p>These are used for QNA and diagnostic functions for the different roles of the Health29 platform.</p>
</div>
<div class="section" id="azure-cognitive-services">
<h3>2.4.3. Azure cognitive services<a class="headerlink" href="#azure-cognitive-services" title="Permalink to this headline">¶</a></h3>
<div class="section" id="computer-vision">
<h4>2.4.3.1. Computer Vision<a class="headerlink" href="#computer-vision" title="Permalink to this headline">¶</a></h4>
<p>It is used in the symptoms section. This service converts images into text in order to obtain the symptoms.</p>
<p>You can configure and use this azure service by following the steps in the <a class="reference external" href="https://docs.microsoft.com/bs-latn-ba/azure/cognitive-services/computer-vision/">Microsoft guide</a>.
And access the one that uses the Health29 platform from this <a class="reference external" href="https://portal.azure.com/#&#64;foundation29outlook.onmicrosoft.com/resource/subscriptions/53348303-e009-4241-9ac7-a8e4465ece27/resourceGroups/health29/providers/Microsoft.CognitiveServices/accounts/recognizetexthealth29/overview">link</a>.</p>
</div>
<div class="section" id="qna-maker">
<h4>2.4.3.2. Qna maker<a class="headerlink" href="#qna-maker" title="Permalink to this headline">¶</a></h4>
<p>QnA Maker is a cloud-based Natural Language Processing (NLP) service that easily creates a natural conversation layer with the data.</p>
<p>In Health29 it is used to manage the FAQs in different ways and from different points of the platform:</p>
<ul class="simple">
<li><p>To show the list of FAQs to the <strong>users</strong>. From the user profile you can access the FAQ page where you will be shown the results of the service consultation in the form of a list.</p></li>
<li><p>So that the <strong>administrators</strong> of the platform can manage the list of FAQs. From the administrator profile you can add, delete and edit the list of FAQs of the service.</p></li>
<li><p>It is integrated into the <strong>healthbot</strong> to allow users to ask questions or doubts in a more guided and personal way.</p></li>
</ul>
<p>In this case the communication of the webapp with this service is requested from the client through an external API that acts as an intermediary. However, there will also be information that will be stored in the databases, therefore, the client will also establish a communication with the server who will manage the storage of this information.</p>
<p>You can configure and use this azure service by following the steps in the <a class="reference external" href="https://docs.microsoft.com/en-us/azure/cognitive-services/qnamaker/">Microsoft guide</a>.
And access the one that uses the Health29 platform from this <a class="reference external" href="https://portal.azure.com/#&#64;foundation29outlook.onmicrosoft.com/resource/subscriptions/53348303-e009-4241-9ac7-a8e4465ece27/resourceGroups/health29/providers/Microsoft.CognitiveServices/accounts/qnamakerhealth29/overview">link</a></p>
<p>In particular for Health29 the following databases have been created in qnamaker: <a class="reference external" href="https://www.qnamaker.ai/Home/MyServices">My knowledge bases</a>. One would be created for each group of patients to contain their specific information and this in turn would be replicated in as many languages as the question-answer pairs are translated on the Health29 platform.</p>
</div>
<div class="section" id="translator">
<h4>2.4.3.3. Translator<a class="headerlink" href="#translator" title="Permalink to this headline">¶</a></h4>
<p>This service is used to be able to make a translation of the different datapoints, to add a new language to the platform (it translates all the tags), and to translate into English the text obtained from the vision service to call the NCR service that extracts the symptoms.</p>
<p>You can configure and use this azure service by following the steps in the <a class="reference external" href="https://docs.microsoft.com/bs-cyrl-ba/azure/cognitive-services/translator/">Microsoft guide</a>.</p>
<p>And access the two that uses the Health29 platform from these links:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://portal.azure.com/#&#64;foundation29outlook.onmicrosoft.com/resource/subscriptions/53348303-e009-4241-9ac7-a8e4465ece27/resourceGroups/health29/providers/Microsoft.CognitiveServices/accounts/health29translateplatform/overview">health29translateplatform</a></p></li>
<li><p><a class="reference external" href="https://portal.azure.com/#&#64;foundation29outlook.onmicrosoft.com/resource/subscriptions/53348303-e009-4241-9ac7-a8e4465ece27/resourceGroups/phenotypeBot/providers/Microsoft.CognitiveServices/accounts/translatorBotApi/overview">translatorBotApi</a></p></li>
</ul>
</div>
</div>
<div class="section" id="azure-healthbot">
<h3>2.4.4. Azure healthbot<a class="headerlink" href="#azure-healthbot" title="Permalink to this headline">¶</a></h3>
<p>Health29 has an assistant to guide the user in the use of the platform.
For this purpose, the Azure <a class="reference external" href="https://docs.microsoft.com/en-us/healthbot/">Healthbot</a> service is used.</p>
<p>It guides the user through different configured scenarios where he or she can perform different actions. Initially we can divide the scenarios into three blocks:</p>
<ul class="simple">
<li><p><strong>New user</strong> scenario or first time in the platform. The chatbot will provide the user with help and guidance in this process and provide he or she with more information if required.</p></li>
<li><p>Scenario of <strong>pending notifications</strong>. In case the user has any pending notifications, he or she will be informed during the first run of the assistant.</p></li>
<li><p><strong>Main</strong> scenario. A series of guided scenarios will appear where the user will be able to make different types of queries.</p></li>
</ul>
<p>You can configure and use this azure service by following the steps in the <a class="reference external" href="https://docs.microsoft.com/en-us/healthbot/quickstart-createyourhealthcarebot">Microsoft guide</a>.
And access the one that uses the Health29 platform from this <a class="reference external" href="https://portal.azure.com/#&#64;foundation29outlook.onmicrosoft.com/resource/subscriptions/53348303-e009-4241-9ac7-a8e4465ece27/resourceGroups/testresourcesjavi/providers/Microsoft.Web/sites/HealthBotContainerSamplef666/appServices">link</a>.</p>
<p>In particular for Health29 the following chatbots have been created (All of them use the previous App Service):</p>
<ul class="simple">
<li><p><a class="reference external" href="https://us.healthbot.microsoft.com/account/zebrahealthbot/scenarios/manage">Healthbot</a> of the development environment.</p></li>
<li><p><a class="reference external" href="https://eu.healthbot.microsoft.com/account/healthbot-test-tjo3h51/scenarios/manage">Healthbot</a> of the test environment.</p></li>
<li><p><a class="reference external" href="https://eu.healthbot.microsoft.com/account/h29bot-giochop/scenarios/manage">Healthbot</a> of the production environment.</p></li>
</ul>
</div>
<div class="section" id="azure-blobs">
<h3>2.4.5. Azure blobs<a class="headerlink" href="#azure-blobs" title="Permalink to this headline">¶</a></h3>
<p>************************TODO:</p>
<ul class="simple">
<li><p>En los blobs de azure, cada paciente tiene su blob donde se guardan pruebas médicas.
Se hace desde el cliente</p></li>
</ul>
</div>
<div class="section" id="databases">
<h3>2.4.6. Databases<a class="headerlink" href="#databases" title="Permalink to this headline">¶</a></h3>
<p>************************TODO:
(DOC health29_DBs)</p>
</div>
</div>
<hr class="docutils" />
<div class="section" id="level-4-code">
<h2>2.5. Level 4: Code<a class="headerlink" href="#level-4-code" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id1">
<h3>2.5.1. Webapp<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>All documentation for the Health29 application code is contained in:</p>
<ul class="simple">
<li><p>For the <a class="reference external" href="https://health29-dev.azurewebsites.net/APIDOC/">development environment</a></p></li>
<li><p>For the <a class="reference external" href="https://health29-test.azurewebsites.net/APIDOC">test environment</a></p></li>
<li><p>For the <a class="reference external" href="https://health29.org/APIDOC/">production environment</a></p></li>
</ul>
<div class="section" id="communication">
<h4>2.5.1.1. Communication<a class="headerlink" href="#communication" title="Permalink to this headline">¶</a></h4>
<p>For establish the communication:</p>
<ul class="simple">
<li><p>The client will make requests of the type:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">this</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">api</span><span class="o">+</span><span class="s1">&#39;/api/&#39;</span><span class="o">+&lt;</span><span class="n">url</span><span class="o">&gt;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">map</span><span class="p">(</span> <span class="p">(</span><span class="n">res</span> <span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="o">//</span> <span class="n">do</span> <span class="n">something</span> <span class="n">when</span> <span class="n">res</span> <span class="n">OK</span>
         <span class="p">},</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
           <span class="o">//</span> <span class="n">do</span> <span class="n">something</span> <span class="n">when</span> <span class="n">error</span>
         <span class="p">})</span>
</pre></div>
</div>
<ul class="simple">
<li><p>The server will listen to these requests and will perform the appropriate operations to give an answer to the client.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">api</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">&lt;</span><span class="n">url</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">auth</span><span class="p">,</span> <span class="n">function</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="code-structure-client-structure">
<h4>2.5.1.2. Code Structure: Client Structure<a class="headerlink" href="#code-structure-client-structure" title="Permalink to this headline">¶</a></h4>
<p><em>NOTE: A template was purchased to have a base: <a class="reference external" href="https://themeforest.net/item/apex-angular-4-bootstrap-admin-template/20774875">Template Link</a>.</em></p>
<p>The structure is as follows:</p>
<p style="text-align: center;">
	<img width="150px" src="../../../source/images/Architecture/Code/Webapp/client/Client_structure.png">
</p><ul>
<li><p>The <strong>src folder</strong> has the following:</p>
  <img align="right" width="150px" src="../../../source/images/Architecture/Code/Webapp/client/Client_structure_src.png"><blockquote>
<div><ul class="simple">
<li><p>app/app.component.{ts,html,css,spec.ts}: Defines the AppComponent along with an HTML template, CSS stylesheet, and a unit test. It is the root component of what will become a tree of nested components as the application evolves. In this file it is controlling the events of inactivity of a session, loading the language of the app depending on the language of the browser, the title that appears in the browser tab with the change of pages. If it is a mobile app, it also controls the backbutton, pause and resume events.</p></li>
<li><p>app/app.module.ts: Defines AppModule, the root module that tells Angular how to assemble the application.</p></li>
<li><p>assets/..: It contains all the information that will be accessible from any url. Css files, js, images, language files, jsons listing countries, types of subscriptions, frequently asked questions for each group of patients, etc. It will be the only visible folder when a build is made for production.</p></li>
<li><p>environments/..: This folder contains one file for each of your destination environments, each exporting simple configuration variables to use in your application. The files are replaced on-the-fly when you build your app. You might use a different API endpoint for development than you do for production or maybe different analytics tokens. You might even use some mock services. Either way, the CLI has you covered. At the moment url of the api, and fitbit credentials</p></li>
<li><p>favicon.ico: Every site wants to look good on the bookmark bar. Get started with your very own Angular icon</p></li>
<li><p>index.html: The main HTML page that is served when someone visits your site. Most of the time you’ll never need to edit it. The CLI automatically adds all js and css files when building your app so you never need to add any script or link tags here manually. For the mobile version, two small changes must be made in this file:
Change base: base href=”./”
Add cordova:  “script src=”cordova.js”</p></li>
<li><p>main.ts: The main entry point for your app. Compiles the application with the JIT compiler and bootstraps the application’s root module (AppModule) to run in the browser. You can also use the AOT compiler without changing any code by passing in –aot to ng build or ng serve</p></li>
<li><p>polyfills.ts: Different browsers have different levels of support of the web standards. Polyfills help normalize those differences. You should be pretty safe with core-js and zone.js, but be sure to check out the Browser Support guide for more information.</p></li>
<li><p>styles.css: Your global styles go here. Most of the time you’ll want to have local styles in your components for easier maintenance, but styles that affect all of your app need to be in a central place.</p></li>
<li><p>test.ts: This is the main entry point for your unit tests. It has some custom configuration that might be unfamiliar, but it’s not something you’ll need to edit.</p></li>
<li><p>tsconfig.{app|spec}.json: TypeScript compiler configuration for the Angular app (tsconfig.app.json) and for the unit tests (tsconfig.spec.json).</p></li>
</ul>
</div></blockquote>
</li>
<li><p>The <strong>app folder</strong> is the one with all the code:</p>
<blockquote>
<div><ul class="simple">
<li><p>Layouts: the different layouts that there are, at the moment two subfolders, for the logged ones (full) and for the ones that are not (content).</p></li>
<li><p>Pages: It has two subfolders, content-pages (corresponds to the logged out pages like login page, registration, etc) and full-pages (common pages for all logged out roles, like the user-profile page).</p></li>
<li><p>admin: contains all pages for the admin role</p></li>
<li><p>superadmin: contains all pages for the superadmin role</p></li>
<li><p>user: contains all the pages for the user role.
Each folder of these roles has a module file (it loads the needed modules), and a route file to manage the routes and control the authentication and authorization (auth-guard and role-guard)</p></li>
</ul>
</div></blockquote>
</li>
<li><p>The <strong>shared folder</strong>, which is the shared code:</p>
  <img align="right" width="150px" src="../../../source/images/Architecture/Code/Webapp/client/Client_structure_shared.png"><blockquote>
<div><ul class="simple">
<li><p>auth: authorization management (role-guard), authentication (auth-service and auth-guard), http interceptor, oauth.services for external services like fitbit.</p></li>
<li><p>Configs: configuration files, for example configuration for toasts, or parameters for graphs.</p></li>
<li><p>Customizer: right side slide (not used at the moment)</p></li>
<li><p>Directives: correspond to the angle directives</p></li>
<li><p>Footer: app footer</p></li>
<li><p>Models: data models</p></li>
<li><p>Navbar and navbar-nolog: It corresponds to the top bar. Navbar-nolog is for when you are not logged in.</p></li>
<li><p>Routes: route management. It has two files, one for the paths of the unlogged pages, and another for the rest.</p></li>
<li><p>Services: corresponds to the angle services. Several have been developed as faq.service or lang.service</p></li>
<li><p>Sidebar: side menu, depending on the role, loads one menu or another.</p></li>
</ul>
</div></blockquote>
</li>
<li><p><strong>Routes</strong>: In the root of the app folder, there is a file called app-routing.module.ts, which is the root of the routes management. Depending on the path, it loads some subroutes and others. For example, if it is unlogged, it loads the routes ./shared/routes/content-layout.routes, on the other hand, if it is logged in it loads ./shared/routes/full-layout.routes. In this second case, check that it is authenticated (canActivate: [AuthGuard])
The rest of the subroutes that come from full-layout, are controlled if they are logged and authenticated in the routing-module file of each module (each profile has a module) with canActivate: [AuthGuard, RoleGuard].</p></li>
</ul>
</div>
<div class="section" id="code-structure-server-structure">
<h4>2.5.1.3. Code Structure: Server Structure<a class="headerlink" href="#code-structure-server-structure" title="Permalink to this headline">¶</a></h4>
<p style="text-align: center;">
	<img width="150px" src="../../../source/images/Architecture/Code/Webapp/server/Server_structure.png">
</p><ul>
<li><p>index.js: file where the app.js and config.js file is loaded It listens to requests.</p></li>
<li><p>Config.js: configuration file. The server url, port, connection with the data bases are passed to it through environment variables. The credentials of the mail that send email, the secret token of jwt, and the secret of crypto are not passed through environment variables.</p></li>
<li><p>Db_connect.js: will be in charge of creating the connection with the databases.</p></li>
<li><p>App.js: the crossdomain is established, and other node configurations. It manages the requests, and these can be of 3 types:</p>
<blockquote>
<div><ol class="simple">
<li><p>API routes managed by routes folder.</p></li>
<li><p>Server-generated view paths (handlebars)</p></li>
<li><p>the paths of the Angular client application (dist folder)</p></li>
</ol>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="build">
<h4>2.5.1.4. Build<a class="headerlink" href="#build" title="Permalink to this headline">¶</a></h4>
<p>By running ng build –prod we minimize and compress the code. This command will create a new folder called dist, and it will have the project optimized. This dist folder will be the one uploaded to the root of the node server that manages the API. It will also be used to create the mobile apps, adding it to the www folder of the cordoba project.</p>
</div>
<div class="section" id="deploy-environments">
<h4>2.5.1.5. Deploy environments<a class="headerlink" href="#deploy-environments" title="Permalink to this headline">¶</a></h4>
<p>Each environment has been created as an independent project, so in order to move from one environment to another you will have to copy the code of one over the new one.
In this process it must be taken into account that the environment.prod file in the environments folder has been previously configured for each environment, and therefore it is different in each one of them. Before making any changes you must ensure that it is kept in the environment to be updated and that during the process of copying code from one environment to another the information in this file is not modified.</p>
</div>
<div class="section" id="external-libraries-and-dependencies">
<h4>2.5.1.6. External libraries and dependencies<a class="headerlink" href="#external-libraries-and-dependencies" title="Permalink to this headline">¶</a></h4>
<p>************************TODO: LIBRERIAS Y DEPENDENCIAS!!!</p>
</div>
</div>
<div class="section" id="id2">
<h3>2.5.2. External APIs<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>API Foundation29 has been designed to act as an intermediary between the webapp and Azure Qnamaker’s service.
The functions that have been implemented to perform actions on the Azure service are analogous to those in the <a class="reference external" href="https://docs.microsoft.com/en-us/azure/cognitive-services/qnamaker/quickstarts/quickstart-rest-curl">Azure documentation</a>.</p>
<p>It can be consulted at the following link: <a class="reference external" href="https://f29api.northeurope.cloudapp.azure.com/index.html">API Foundation29</a>.
And the functionality and methodology of use is described in the qnamaker section of this document (2.5.3.2. Qna maker)</p>
<p>Some functions to use the monarch API from this have also been included in this API. But this is not being used at the moment in health29 and the calls to the monarch API are executed directly, without intermediaries.</p>
<p>Todavía no tenemos desplegado todo lo de monarch, por ello aún hacemos alguna petición a sus servicios,  para obtener la lista de condiciones relacionadas:</p>
<ul class="simple">
<li><p>Request for list of related conditions</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>request({
url: https://api.monarchinitiative.org/api/sim/search?is_feature_set=true&amp;metric=phenodigm&amp;id=HP:0001250&amp;id=HP:0002133&amp;limit=100&amp;taxon=9606’,
json: true
}
</pre></div>
</div>
<ul class="simple">
<li><p>To open a new link for information on a symptom</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">href</span><span class="o">=</span><span class="s2">&quot;https://monarchinitiative.org/phenotype/&#39;+res[j].id+&#39;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>To obtain information about a disease:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>href=”https://monarchinitiative.org/disease/{{value.id}}#overview 
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h3>2.5.3. Azure cognitive services<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id4">
<h4>2.5.3.1. Computer Vision<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<p>To create it from azure you just have to select the cognitive service in the marketplace: “ComputerVision”.
The configuration has no complexity, just select the Price tier and the resource group.</p>
<p>It is used in the webapp client, as it has been indicated until now, establishing a REST communication:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">this</span><span class="o">.</span><span class="n">subscription</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">this</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;https://westeurope.api.cognitive.microsoft.com/vision/v1.0/ocr?language=&#39;</span><span class="o">+</span><span class="n">this</span><span class="o">.</span><span class="n">cognitiveServicesLanguage</span> <span class="o">+</span><span class="s1">&#39;&amp;detectOrientation=true&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="o">.</span><span class="n">subscribe</span><span class="p">(</span> <span class="p">(</span><span class="n">res</span> <span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    	<span class="o">//</span> <span class="n">Do</span> <span class="n">something</span> <span class="n">when</span> <span class="n">result</span> <span class="n">OK</span>
	<span class="p">},</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
     <span class="o">//</span> <span class="n">Do</span> <span class="n">something</span> <span class="n">when</span> <span class="n">error</span>
<span class="p">}));</span>
</pre></div>
</div>
<p>And the configuration of the headers (auth.interceptor.ts) to use this service is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">indexOf</span><span class="p">(</span><span class="s1">&#39;api.cognitive.microsoft.com/vision&#39;</span><span class="p">)</span><span class="o">!==-</span><span class="mi">1</span><span class="p">){</span>
  <span class="n">isExternalReq</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
  <span class="n">const</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">new</span> <span class="n">HttpHeaders</span><span class="p">({</span>
    <span class="s1">&#39;Ocp-Apim-Subscription-Key&#39;</span><span class="p">:</span> <span class="s1">&#39;992ab4c1c5ff4412a052b0d170feeab8&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/octet-stream&#39;</span>
  <span class="p">});</span>
  <span class="n">authReq</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">clone</span><span class="p">({</span> <span class="n">headers</span><span class="p">});</span><span class="o">//</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span>  <span class="s1">&#39;application/json&#39;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As it has been said before this is used for the symptom extraction, so the call is made in phenotypes.component.ts.</p>
<p>All the commands and settings for establishing this communication are described in the <a class="reference external" href="https://docs.microsoft.com/bs-latn-ba/azure/cognitive-services/computer-vision/vision-api-how-to-topics/howtocallvisionapi">Microsoft documentation</a>.</p>
</div>
<div class="section" id="id5">
<h4>2.5.3.2. Qna maker<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<p>To create it from azure you just have to select the cognitive service in the marketplace: “Qna maker”.
The configuration has no complexity, just:</p>
<ul class="simple">
<li><p>Enter a name</p></li>
<li><p>Select subscription of Azure, the Price tier, the resource group adn the localization.</p></li>
<li><p>Enter an application name for establish the url: “app_name.azurewebsites.net”</p></li>
</ul>
<p>As previously stated, in Health29 it is used to manage the FAQs in different ways and from different points of the platform. To work with the data of this azure service, an external API will be used as an intermediary: f29API, described in the previous section, so that all calls will be made to it. However, the same format has been used as if the calls were made directly to Azure’s service, as an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">this</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://f29api.northeurope.cloudapp.azure.com/api/knowledgebases/&#39;</span><span class="o">+</span><span class="n">knowledgeBaseID</span><span class="o">+</span><span class="s1">&#39;/Prod/qna&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">map</span><span class="p">(</span> <span class="p">(</span><span class="n">res</span> <span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="o">//</span> <span class="n">Do</span> <span class="n">something</span> <span class="n">when</span> <span class="n">get</span> <span class="n">the</span> <span class="n">Knoledbase</span> <span class="n">information</span>
	<span class="p">},</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
     <span class="o">//</span> <span class="n">Do</span> <span class="n">something</span> <span class="n">when</span> <span class="n">error</span>
<span class="p">}));</span>
</pre></div>
</div>
<p>And with the configuration of the headers (auth.interceptor.ts) to use this service the same thing happens, the ones that would be necessary to establish the connection with Azure’s service are sent:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">indexOf</span><span class="p">(</span><span class="s1">&#39;https://f29api.northeurope.cloudapp.azure.com&#39;</span><span class="p">)</span><span class="o">!==-</span><span class="mi">1</span><span class="p">){</span>
  <span class="n">isExternalReq</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
  <span class="n">const</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">new</span> <span class="n">HttpHeaders</span><span class="p">({</span>
    <span class="s1">&#39;Ocp-Apim-Subscription-Key&#39;</span><span class="p">:</span> <span class="s1">&#39;8d7bca89da4e42c1bf79b292207c9635&#39;</span>
  <span class="p">});</span>
  <span class="n">authReq</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">clone</span><span class="p">({</span> <span class="n">headers</span><span class="p">});</span>
<span class="p">}</span>
</pre></div>
</div>
<p>All the commands and settings for establishing this communication are described in the <a class="reference external" href="https://docs.microsoft.com/en-us/azure/cognitive-services/qnamaker/quickstarts/quickstart-rest-curl">Microsoft documentation</a>.</p>
</div>
<div class="section" id="id6">
<h4>2.5.3.3. Translator<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<p>To create it from azure you just have to select the cognitive service in the marketplace: “Translator text”.
The configuration has no complexity, just select the Price tier and the resource group.</p>
<p>It is used in the webapp client, as it has been indicated until now, establishing a REST communication:</p>
<ul class="simple">
<li><p>First case: communication without authorization required.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">this</span><span class="o">.</span><span class="n">subscription</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">this</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;https://api.cognitive.microsofttranslator.com/translate?api-version=3.0&amp;to=&#39;</span><span class="o">+</span><span class="n">this</span><span class="o">.</span><span class="n">authService</span><span class="o">.</span><span class="n">getLang</span><span class="p">(),</span> <span class="n">jsonText</span><span class="p">)</span>
    <span class="o">.</span><span class="n">subscribe</span><span class="p">(</span> <span class="p">(</span><span class="n">res</span> <span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    	<span class="o">//</span> <span class="n">Do</span> <span class="n">something</span> <span class="n">when</span> <span class="n">it</span> <span class="n">returns</span> <span class="n">the</span> <span class="n">text</span> <span class="kn">from</span> <span class="nn">jsonText</span> <span class="n">translated</span>
    <span class="p">},</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
       <span class="o">//</span> <span class="n">Do</span> <span class="n">something</span> <span class="n">when</span> <span class="n">error</span>
    <span class="p">}));</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Second case: communication with authorization required.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">this</span><span class="o">.</span><span class="n">subscription</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">this</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;https://api.cognitive.microsoft.com/sts/v1.0/issueToken&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">subscribe</span><span class="p">(</span> <span class="p">(</span><span class="n">res</span> <span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      	<span class="o">//</span> <span class="n">get</span> <span class="n">the</span> <span class="n">token</span> <span class="k">for</span> <span class="n">establish</span> <span class="n">communication</span> <span class="n">between</span> <span class="n">webapp</span> <span class="ow">and</span> <span class="n">text</span> <span class="n">translator</span>
        <span class="n">sessionStorage</span><span class="o">.</span><span class="n">setItem</span><span class="p">(</span><span class="s1">&#39;tokenMicrosoftTranslator&#39;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="p">},</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
	 	<span class="o">//</span> <span class="n">Do</span> <span class="n">something</span> <span class="n">when</span> <span class="n">error</span>
	<span class="p">}));</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">this</span><span class="o">.</span><span class="n">subscription</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">this</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://api.microsofttranslator.com/V2/Http.svc/Translate?appid=Bearer&#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">sessionStorage</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="s1">&#39;tokenMicrosoftTranslator&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;&amp;text=&#39;</span><span class="o">+&lt;</span><span class="n">text</span><span class="o">&gt;+</span><span class="s1">&#39;&amp;to=en&amp;Authorization=Bearer&#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">sessionStorage</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="s1">&#39;tokenMicrosoftTranslator&#39;</span><span class="p">))</span>
	<span class="o">.</span><span class="n">subscribe</span><span class="p">(</span> <span class="p">(</span><span class="n">res</span> <span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
		<span class="o">//</span> <span class="n">Do</span> <span class="n">something</span> <span class="n">when</span> <span class="n">it</span> <span class="n">returns</span> <span class="n">the</span> <span class="n">text</span> <span class="kn">from</span> <span class="o">&lt;</span><span class="n">text</span><span class="o">&gt;</span> <span class="n">translated</span>
	<span class="p">},</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
	 	<span class="o">//</span> <span class="n">Do</span> <span class="n">something</span> <span class="n">when</span> <span class="n">error</span>
	<span class="p">}));</span>
</pre></div>
</div>
<p>And the configuration of the headers (auth.interceptor.ts) to use this service is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">indexOf</span><span class="p">(</span><span class="s1">&#39;https://api.cognitive.microsoft.com/sts/v1.0/issueToken&#39;</span><span class="p">)</span><span class="o">!==-</span><span class="mi">1</span><span class="p">){</span>
  <span class="n">isExternalReq</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
  <span class="n">authReq</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">clone</span><span class="p">({</span> <span class="n">headers</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;Ocp-Apim-Subscription-Key&#39;</span><span class="p">,</span>  <span class="s1">&#39;7174b790ef59409280f77dd94c34a9d2&#39;</span> <span class="p">),</span> <span class="n">responseType</span><span class="p">:</span> <span class="s1">&#39;text&#39;</span><span class="p">});</span>
<span class="p">}</span>

<span class="k">if</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">indexOf</span><span class="p">(</span><span class="s1">&#39;https://api.microsofttranslator.com&#39;</span><span class="p">)</span><span class="o">!==-</span><span class="mi">1</span><span class="p">){</span>
  <span class="n">isExternalReq</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
  <span class="n">authReq</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">clone</span><span class="p">({</span> <span class="n">responseType</span><span class="p">:</span> <span class="s1">&#39;text&#39;</span> <span class="p">});</span>
<span class="p">}</span>
<span class="k">if</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">indexOf</span><span class="p">(</span><span class="s1">&#39;https://api.cognitive.microsofttranslator.com&#39;</span><span class="p">)</span><span class="o">!==-</span><span class="mi">1</span><span class="p">){</span>
  <span class="n">isExternalReq</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
  <span class="n">authReq</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">clone</span><span class="p">({</span> <span class="n">headers</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;Ocp-Apim-Subscription-Key&#39;</span><span class="p">,</span>  <span class="s1">&#39;7174b790ef59409280f77dd94c34a9d2&#39;</span> <span class="p">)</span> <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The first of these is used to translate the datapoints and to add a new language to the platform, while the second is used in the symptom section (phenotype) to translate into English the text obtained from the vision service.</p>
<p>All the commands and settings for establishing this communication are described in the <a class="reference external" href="https://docs.microsoft.com/bs-cyrl-ba/azure/cognitive-services/translator/">Microsoft documentation</a>.</p>
</div>
</div>
<div class="section" id="id7">
<h3>2.5.4. Azure Healthbot<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>To create it from azure you just have to select the cognitive service in the marketplace: “Healthcare Bot”.
To create and configure it, just follow the steps in the <a class="reference external" href="https://docs.microsoft.com/en-us/healthbot/quickstart-createyourhealthcarebot">Microsoft guide</a>.</p>
<p>In the case of Health29, the App service <a class="reference external" href="https://healthbotcontainersamplef666.scm.azurewebsites.net/dev/wwwroot/server.js">server</a> has been configured to be able to deploy the three bots depending on the webapp client that is running it. So that:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">var</span> <span class="n">WEBCHAT_SECRET</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">WEBCHAT_SECRET</span><span class="p">;</span>
<span class="n">var</span> <span class="n">APP_SECRET</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">APP_SECRET</span><span class="p">;</span>
<span class="k">if</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="s1">&#39;https://health29.org&#39;</span><span class="p">){</span>
    
<span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="s1">&#39;https://health29-test.azurewebsites.net&#39;</span><span class="p">){</span>
    <span class="n">WEBCHAT_SECRET</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">WEBCHAT_SECRET_TEST</span><span class="p">;</span>
    <span class="n">APP_SECRET</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">APP_SECRET_TEST</span><span class="p">;</span>
<span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="s1">&#39;http://localhost:4200&#39;</span> <span class="o">||</span> <span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span><span class="s1">&#39;https://health29-dev.azurewebsites.net&#39;</span><span class="p">){</span>
    <span class="n">WEBCHAT_SECRET</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">WEBCHAT_SECRET_DEV</span><span class="p">;</span>
    <span class="n">APP_SECRET</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">APP_SECRET_DEV</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>It should be noted that this service has a monthly message limit. Depending on the rate chosen in each of the Healthbots, a greater or lesser flow of information exchange or interactions of the Health29 assistant will be allowed.</p>
<p><em>NOTE: if at any time the limit is exceeded, the bot will return error 429 (Too many request).</em></p>
<p>The incorporation of this assistant to the webapp is done from the client, in particular, from the customizer component.</p>
<p>(Meter imagen https://docs.microsoft.com/en-us/healthbot/integrations/embed)</p>
<p>This way, it is added to the HTML:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">div</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;botContainer&quot;</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;width:95%&quot;</span><span class="o">&gt;&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>And the style is added from the scss file.</p>
<p>As for the functionality of the bot, this is included in the “.ts” file, taking into account:</p>
<p>( Meter imagen: https://docs.microsoft.com/en-us/healthbot/integrations/embed)</p>
<p>So, the steps to follow are:</p>
<ol class="simple">
<li><p>Get the token for the connection with the azure service:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">var</span> <span class="n">paramssend</span> <span class="o">=</span> <span class="p">{</span> <span class="n">userName</span><span class="p">:</span> <span class="n">this</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">userName</span><span class="p">,</span> <span class="n">userId</span><span class="p">:</span> <span class="n">this</span><span class="o">.</span><span class="n">authService</span><span class="o">.</span><span class="n">getIdUser</span><span class="p">(),</span> <span class="n">token</span><span class="p">:</span> <span class="n">this</span><span class="o">.</span><span class="n">authService</span><span class="o">.</span><span class="n">getToken</span><span class="p">(),</span> <span class="n">groupId</span><span class="p">:</span> <span class="n">this</span><span class="o">.</span><span class="n">groupId</span><span class="p">,</span> <span class="n">lang</span><span class="p">:</span> <span class="n">this</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">lang</span><span class="p">,</span> <span class="n">knowledgeBaseID</span><span class="p">:</span> <span class="n">this</span><span class="o">.</span><span class="n">knowledgeBaseID</span><span class="p">};</span> 
<span class="n">this</span><span class="o">.</span><span class="n">subscription</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">this</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://healthbotcontainersamplef666.azurewebsites.net:443/chatBot&#39;</span><span class="p">,{</span><span class="n">params</span><span class="p">:</span> <span class="n">paramssend</span><span class="p">})</span>
	<span class="o">.</span><span class="n">subscribe</span><span class="p">(</span> <span class="p">(</span><span class="n">res</span> <span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
		<span class="o">//</span> <span class="n">Get</span> <span class="n">the</span> <span class="n">token</span> <span class="n">OK</span>
	<span class="p">},</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
		<span class="o">//</span> <span class="n">Get</span> <span class="n">the</span> <span class="n">token</span> <span class="n">Error</span>
<span class="p">}));</span>
</pre></div>
</div>
<ol class="simple">
<li><p>Create a bot connection:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">jsonWebToken</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
<span class="n">const</span> <span class="n">tokenPayload</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">atob</span><span class="p">(</span><span class="n">jsonWebToken</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]));</span>
<span class="n">const</span> <span class="n">user</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nb">id</span><span class="p">:</span> <span class="n">tokenPayload</span><span class="o">.</span><span class="n">userId</span><span class="p">,</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">tokenPayload</span><span class="o">.</span><span class="n">userName</span>
<span class="p">};</span>
<span class="n">const</span> <span class="n">botConnection</span> <span class="o">=</span> <span class="n">new</span> <span class="n">BotChat</span><span class="o">.</span><span class="n">DirectLine</span><span class="p">({</span>
  <span class="o">//</span><span class="n">secret</span><span class="p">:</span> <span class="n">botSecret</span><span class="p">,</span>
  <span class="n">token</span><span class="p">:</span> <span class="n">tokenPayload</span><span class="o">.</span><span class="n">connectorToken</span><span class="p">,</span>
  <span class="o">//</span><span class="n">domain</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
  <span class="n">webSocket</span><span class="p">:</span> <span class="n">true</span>
<span class="p">});</span>
</pre></div>
</div>
<ol class="simple">
<li><p>Start conversation</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>const botContainer = document.getElementById(&#39;botContainer&#39;);
$(&#39;#botContainer&#39;).empty();
botContainer.classList.add(&quot;wc-display&quot;);   
BotChat.App({
    botConnection: botConnection,
    user: user,
    locale: this.user.lang,
    bot: {id: &#39;&#39;},//id: &#39;h29bot-giochop&#39; //id: &#39;zebrahealthbot&#39;
    resize: &#39;detect&#39;
    // sendTyping: true,    // defaults to false. set to true to send &#39;typing&#39; activities to bot (and other users) when user is typing
}, botContainer);
</pre></div>
</div>
<ol class="simple">
<li><p>A communication will be established with it to exchange information and perform the relevant actions:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">this</span><span class="o">.</span><span class="n">subscription</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">botConnection</span><span class="o">.</span><span class="n">postActivity</span><span class="p">({</span><span class="nb">type</span><span class="p">:</span> <span class="s2">&quot;event&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">jsonWebToken</span><span class="p">,</span> <span class="n">from</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;InitAuthenticatedConversation&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">function</span> <span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="p">{</span>
     <span class="o">//</span> <span class="n">Start</span> <span class="n">scenarios</span>
<span class="p">},</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
		<span class="o">//</span> <span class="n">Do</span> <span class="n">something</span> <span class="n">when</span> <span class="n">error</span>
<span class="p">}));</span>
</pre></div>
</div>
<p>All the commands and settings for using this Healthbot service ara available in <a class="reference external" href="https://docs.microsoft.com/en-us/healthbot/integrations/embed">Microsoft documentation</a>.</p>
<p>As already indicated, once the bot is embedded in the webapp you will have to indicate it to initialize the desired scenarios in each case. These scenarios are designed, implemented and configured in:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://us.healthbot.microsoft.com/account/zebrahealthbot/scenarios/manage">Healthbot</a> of the development environment.</p></li>
<li><p><a class="reference external" href="https://eu.healthbot.microsoft.com/account/healthbot-test-tjo3h51/scenarios/manage">Healthbot</a> of the test environment.</p></li>
<li><p><a class="reference external" href="https://eu.healthbot.microsoft.com/account/h29bot-giochop/scenarios/manage">Healthbot</a> of the production environment.</p></li>
</ul>
<p>In the microsoft documentation there are <a class="reference external" href="https://docs.microsoft.com/en-us/healthbot/quickstart-createyourfirstscenario">guides</a> to help you create these scenarios.</p>
<p>************************TODO:</p>
<p>(ESQUEMA ACTUAL DE CONEXION DE ESCENARIOS DE H29)</p>
<p>(Explicar que ahora mismo se triplica cada escenario de acuerdo con el idioma del usuario de H29, a futuro habría que modificar todo para utilziar la localizacion del bot para conseguir estas traducciones pero en ese caso tener en cuenta que tambien tienen
que traducirse los mensajes de error que manda el bot “Oops…” que estan contemplados en la app H29 ahora mismo: se tratan desde la aplicacion y se modifica el texto para el idioma correspondiente)</p>
</div>
<div class="section" id="id8">
<h3>2.5.5. Azure blobs<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p>************************TODO:</p>
</div>
<div class="section" id="id9">
<h3>2.5.6. Databases<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p>************************TODO:</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="Superadmin profile.html" class="btn btn-neutral float-right" title="Superadmin profile" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="Environments.html" class="btn btn-neutral float-left" title="Environments" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Foundation29

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>