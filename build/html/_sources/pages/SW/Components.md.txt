<img align="right" width="100px" src="../../_images/Foundation29.png">

## 2.3. Level 3: Component

Taking into account the division by containers exposed in the previous point, we are now going to study in detail the internal architecture and the components that make up each one of them.

### 2.3.1. Webapp

Health29's architecture uses a client-server software design model, so that the architecture of the webapp is like:

<img width="800px" src="../../_images/Webapp.jpg">

For the client we use the Angular 5 framework, and for the nodejs - express server, in which we have implemented an API to connect to the CosmoDb databases using mongoose for its management.

<img width="800px" src="../../_images/Webapp_frameworks_architecture.jpg">

These modules are intercommunicated using a [REST](https://restfulapi.net/) interface, that is, the communication is established according to the [HTTP protocol](https://restfulapi.net/http-methods/). 

This communication between client and server is mainly used for data management, i.e. to obtain, add or modify information from databases.
For this purpose, an HTTP service will be used to allow, through requests from the client to the server, to carry out these operations. The server will listen to these requests and will perform the appropriate operations to give an answer to the client.
- Most requests to the API require an access token as authentication. For this, go to Get access_token
- Once we have the access token, we can make the calls to the api, passing the access token in the header.

All Methods APIs that have the authorization field in the header use Bearer authentication to restrict access to protected resources, , and always be sent next to a token. The bearer token is a cryptic string, generated by the server in response to a login request. Example of the header: Authorization: Bearer "token"

These requests can return some errors, such as the token is invalid, or has expired: { status: 401, message: "Token expired"} or { status: 401, message: "Invalid Token"}

As the client is implemented using the Angular 5 framework, when compiling it ([ng build](https://angular.io/guide/deployment)) you will get a "/dist" folder that must be included in the server for the construction of the platform. This is further detailed in the Environments section of this document, in the build section of the project.

### 2.3.2. External APIs
**[Foundation29 API](https://f29api.northeurope.cloudapp.azure.com/index.html)**, implemented by Foundation29 to use it as an intermediary between the webapp and the azure qnamaker service. It is used for QNA functions for the different roles of Health29 platform.

**The [Monarch](https://api.monarchinitiative.org/) API**, is an external API that is used for the diagnostic functions for the different roles of the Health29 platform. 


### 2.3.3. Azure cognitive services
#### 2.3.3.1. Computer Vision
It is used in the symptoms section. This service converts images into text in order to obtain the symptoms.

You can configure and use this azure service by following the steps in the [Microsoft guide](https://docs.microsoft.com/bs-latn-ba/azure/cognitive-services/computer-vision/). 
And access the one that uses the Health29 platform from this [link](https://portal.azure.com/#@foundation29outlook.onmicrosoft.com/resource/subscriptions/53348303-e009-4241-9ac7-a8e4465ece27/resourceGroups/health29/providers/Microsoft.CognitiveServices/accounts/recognizetexthealth29/overview).

#### 2.3.3.2. Qna maker
QnA Maker is a cloud-based Natural Language Processing (NLP) service that easily creates a natural conversation layer with the data. 

In Health29 it is used to manage the FAQs in different ways and from different points of the platform:

- To show the list of FAQs to the **users**. From the user profile you can access the FAQ page where you will be shown the results of the service consultation in the form of a list.

- So that the **administrators** of the platform can manage the list of FAQs. From the administrator profile you can add, delete and edit the list of FAQs of the service.

- It is integrated into the **healthbot** to allow users to ask questions or doubts in a more guided and personal way. 

In this case the communication of the webapp with this service is requested from the client through an external API that acts as an intermediary. However, there will also be information that will be stored in the databases, therefore, the client will also establish a communication with the server who will manage the storage of this information.

You can configure and use this azure service by following the steps in the [Microsoft guide](https://docs.microsoft.com/en-us/azure/cognitive-services/qnamaker/).
And access the one that uses the Health29 platform from this [link](https://portal.azure.com/#@foundation29outlook.onmicrosoft.com/resource/subscriptions/53348303-e009-4241-9ac7-a8e4465ece27/resourceGroups/health29/providers/Microsoft.CognitiveServices/accounts/qnamakerhealth29/overview)

In particular for Health29 the following databases have been created in qnamaker: [My knowledge bases](https://www.qnamaker.ai/Home/MyServices). One would be created for each group of patients to contain their specific information and this in turn would be replicated in as many languages as the question-answer pairs are translated on the Health29 platform.


#### 2.3.3.3. Translator
This service is used to be able to make a translation of the different datapoints, to add a new language to the platform (it translates all the tags), and to translate into English the text obtained from the vision service to call the NCR service that extracts the symptoms.

You can configure and use this azure service by following the steps in the [Microsoft guide](https://docs.microsoft.com/bs-cyrl-ba/azure/cognitive-services/translator/).

And access the two that uses the Health29 platform from these links:
- [health29translateplatform](https://portal.azure.com/#@foundation29outlook.onmicrosoft.com/resource/subscriptions/53348303-e009-4241-9ac7-a8e4465ece27/resourceGroups/health29/providers/Microsoft.CognitiveServices/accounts/health29translateplatform/overview)
- [translatorBotApi](https://portal.azure.com/#@foundation29outlook.onmicrosoft.com/resource/subscriptions/53348303-e009-4241-9ac7-a8e4465ece27/resourceGroups/phenotypeBot/providers/Microsoft.CognitiveServices/accounts/translatorBotApi/overview)


### 2.3.4. Azure healthbot

Health29 has an assistant to guide the user in the use of the platform.
For this purpose, the Azure [Healthbot](https://docs.microsoft.com/en-us/healthbot/) service is used.

It guides the user through different configured scenarios where he or she can perform different actions. Initially we can divide the scenarios into three blocks:
- **New user** scenario or first time in the platform. The chatbot will provide the user with help and guidance in this process and provide he or she with more information if required.
- Scenario of **pending notifications**. In case the user has any pending notifications, he or she will be informed during the first run of the assistant.
- **Main** scenario. A series of guided scenarios will appear where the user will be able to make different types of queries.

You can configure and use this azure service by following the steps in the [Microsoft guide](https://docs.microsoft.com/en-us/healthbot/quickstart-createyourhealthcarebot). 
And access the one that uses the Health29 platform from this [link](https://portal.azure.com/#@foundation29outlook.onmicrosoft.com/resource/subscriptions/53348303-e009-4241-9ac7-a8e4465ece27/resourceGroups/testresourcesjavi/providers/Microsoft.Web/sites/HealthBotContainerSamplef666/appServices).

In particular for Health29 the following chatbots have been created (All of them use the previous App Service):
- [Healthbot](https://us.healthbot.microsoft.com/account/zebrahealthbot/scenarios/manage) of the development environment.
- [Healthbot](https://eu.healthbot.microsoft.com/account/healthbot-test-tjo3h51/scenarios/manage) of the test environment.
- [Healthbot](https://eu.healthbot.microsoft.com/account/h29bot-giochop/scenarios/manage) of the production environment.


### 2.3.5. Azure blobs
Azure Blob storage is Microsoft's object storage solution for the cloud. Blob storage is optimized for storing massive amounts of unstructured data. Unstructured data is data that doesn't adhere to a particular data model or definition, such as text or binary data.

Two "Storage accounts (classic)" container called "blobgenomics" adn "health29support" has been created to store information from various sections of Health29.
For the first one:
- Medical care section. Here, one container per patient is created to store their medical information.
- Diagnosis section. As in the previous point, one container per patient is created to store the diagnostic information.
- User profile section. Used to export patient data in PDF or JSON format. A container per patient is also created.
- Genotype section. One container per patient is created to store the genotype data of the patient.
- Phenotype section. Same as above but for saving the phenotype data.

The second has been created to manage the data of support section. Unlike the previous ones, only a container named "filessupport" is created for this data to store the data related to the Health29 platform support.

You can configure and use this azure service by following the steps in the [Microsoft guide](https://docs.microsoft.com/es-es/azure/storage/blobs/storage-blobs-introduction). 
And access the two that uses the Health29 platform from these links:

- [blobgenomics](https://portal.azure.com/#@foundation29outlook.onmicrosoft.com/resource/subscriptions/53348303-e009-4241-9ac7-a8e4465ece27/resourceGroups/health29/providers/Microsoft.Storage/storageAccounts/blobgenomics/containersList).
- [health29support](https://portal.azure.com/#@foundation29outlook.onmicrosoft.com/resource/subscriptions/53348303-e009-4241-9ac7-a8e4465ece27/resourceGroups/health29/providers/Microsoft.Storage/storageAccounts/health29support/overview)

### 2.3.6. Other services
- The [Genomics Functions apps](https://portal.azure.com/#blade/WebsitesExtension/FunctionsIFrameBlade/id/%2Fsubscriptions%2F53348303-e009-4241-9ac7-a8e4465ece27%2FresourceGroups%2Fhealth29%2Fproviders%2FMicrosoft.Web%2Fsites%2FGenomicServices) for phenolyze and exomize tasks. It is an Azure service.
- The [DiagnosisApi](https://portal.azure.com/#@foundation29outlook.onmicrosoft.com/resource/subscriptions/53348303-e009-4241-9ac7-a8e4465ece27/resourceGroups/phenotypeBot/providers/Microsoft.Web/sites/DiagnosisApi/appServices) is an App Service of Azure that is used for consulting the symptons of a diagnose. It is an Azure service.

### 2.3.7. Databases
We have several separate collections in two databases, one for accounts and general things, and one for patient data. 
 
The development and test environments share the same databases, while the production ones do not. So, in total we have 4 databases:
- Two for accounts
>- Development and testing: [health29-accounts-test](https://portal.azure.com/#@foundation29outlook.onmicrosoft.com/resource/subscriptions/53348303-e009-4241-9ac7-a8e4465ece27/resourceGroups/health29/providers/Microsoft.DocumentDb/databaseAccounts/health29-accounts-test/overview)
>- Production: [health29-accounts-final](https://portal.azure.com/#@foundation29outlook.onmicrosoft.com/resource/subscriptions/53348303-e009-4241-9ac7-a8e4465ece27/resourceGroups/health29/providers/Microsoft.DocumentDb/databaseAccounts/health29-accounts-final/overview)
- Two for patient data
>- Development and testing: [health29-data-test](https://portal.azure.com/#@foundation29outlook.onmicrosoft.com/resource/subscriptions/53348303-e009-4241-9ac7-a8e4465ece27/resourceGroups/health29/providers/Microsoft.DocumentDb/databaseAccounts/health29-data-test/overview)
>- Production: [health29-data-final](https://portal.azure.com/#@foundation29outlook.onmicrosoft.com/resource/subscriptions/53348303-e009-4241-9ac7-a8e4465ece27/resourceGroups/health29/providers/Microsoft.DocumentDb/databaseAccounts/health29-data-final/overview)

Access from the Health29 platform is done from the application server,using [mongoose](https://mongoosejs.com/docs/).
