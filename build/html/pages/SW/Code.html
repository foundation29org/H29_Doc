

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>2.4. Level 4: Code &mdash; H29 1.0 documentation</title>








  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>


      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>

    <script type="text/javascript" src="../../_static/js/theme.js"></script>




  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="3. Superadmin profile" href="../Superadmin profile.html" />
    <link rel="prev" title="2.3. Level 3: Component" href="Components.html" />
</head>

<body class="wy-body-for-nav">


  <div class="wy-grid-for-nav">

    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >



            <a href="../../index.html" class="icon icon-home"> H29



          </a>







<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>


        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">






              <p class="caption"><span class="caption-text">H29</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Environments.html">1. Environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Environments/Azure_App_Services.html">1.1. Azure App service: Health29</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Environments/Code_repository.html">1.2. Code repositories</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Environments/Build_deploy.html">1.3. Build and deploy environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Software architecture.html">2. Software architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="SystemContext.html">2.1. Level 1: System Context</a></li>
<li class="toctree-l1"><a class="reference internal" href="Containers.html">2.2. Level 2: Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="Components.html">2.3. Level 3: Component</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">2.4. Level 4: Code</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#webapp">2.4.1. Webapp</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#azure-app-service">2.4.1.1. Azure App service</a></li>
<li class="toctree-l3"><a class="reference internal" href="#modules-communication">2.4.1.2. Modules communication</a></li>
<li class="toctree-l3"><a class="reference internal" href="#code-structure-client-structure">2.4.1.3. Code Structure: Client Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="#code-structure-server-structure">2.4.1.4. Code Structure: Server Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="#external-libraries-and-dependencies">2.4.1.4. External libraries and dependencies</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#external-apis">2.4.2. External APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#azure-cognitive-services">2.4.3. Azure cognitive services</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#computer-vision">2.4.3.1. Computer Vision</a></li>
<li class="toctree-l3"><a class="reference internal" href="#qna-maker">2.4.3.2. Qna maker</a></li>
<li class="toctree-l3"><a class="reference internal" href="#translator">2.4.3.3. Translator</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#azure-healthbot">2.4.4. Azure Healthbot</a></li>
<li class="toctree-l2"><a class="reference internal" href="#azure-blobs">2.4.5. Azure blobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#other-services">2.4.6. Other services</a></li>
<li class="toctree-l2"><a class="reference internal" href="#databases">2.4.7. Databases</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#databases-and-health29-communication">2.4.7.1. Databases and health29 communication</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ddbb-accounts">2.4.7.2. DDBB: Accounts</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ddbb-data">2.4.7.3. DDBB: Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#collections-relationship">2.4.7.4. Collections relationship</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#multilanguage">2.4.8. Multilanguage</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#multilanguage-in-client">2.4.8.1. Multilanguage in client</a></li>
<li class="toctree-l3"><a class="reference internal" href="#multilanguage-in-server">2.4.8.2. Multilanguage in server</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#second-factor-autenthication">2.4.9. Second factor autenthication</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Superadmin profile.html">3. Superadmin profile</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Technical debt.html">4. Technical debt</a></li>
</ul>



        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">


      <nav class="wy-nav-top" aria-label="top navigation">

          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">H29</a>

      </nav>


      <div class="wy-nav-content">

        <div class="rst-content">

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">

      <li><a href="../../index.html">Docs</a> &raquo;</li>

      <li>2.4. Level 4: Code</li>


      <li class="wy-breadcrumbs-aside">


            <a href="../../_sources/pages/SW/Code.md.txt" rel="nofollow"> View page source</a>


      </li>

  </ul>


  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">

  <img align="right" width="100px" src="../../_images/Foundation29.png"><div class="section" id="level-4-code">
<h1>2.4. Level 4: Code<a class="headerlink" href="#level-4-code" title="Permalink to this headline">¶</a></h1>
<div class="section" id="webapp">
<h2>2.4.1. Webapp<a class="headerlink" href="#webapp" title="Permalink to this headline">¶</a></h2>
<p>All documentation for the Health29 application code is contained in:</p>
<ul class="simple">
<li><p>For the <a class="reference external" href="https://health29-dev.azurewebsites.net/APIDOC/">development environment</a></p></li>
<li><p>For the <a class="reference external" href="https://health29-test.azurewebsites.net/APIDOC">test environment</a></p></li>
<li><p>For the <a class="reference external" href="https://health29.org/APIDOC/">production environment</a></p></li>
</ul>
<p>For Android and iOS apps, we use the cordova framework. When compiling the Angular project, it generates the dist folder, which is the one to be added to the www folder of the Corova project.  We were evaluating ionic, nativescript and reactscript, they would be good options if we were more people, but at the moment we fit more cordova.</p>
<p>Our idea is to migrate to FHIR, so we would have to modify our API to make calls to <a class="reference external" href="https://www.hl7.org/fhir/">FHIR’s API</a></p>
<p>Health29 provides a web API to access the data. Anyone can develop an application to access and modify the data of a Health29 user. OAuth 2.0 is used as an authorization protocol to give an API client limited access to the user’s data.</p>
<div class="section" id="azure-app-service">
<h3>2.4.1.1. Azure App service<a class="headerlink" href="#azure-app-service" title="Permalink to this headline">¶</a></h3>
<p>A <strong><a class="reference external" href="https://docs.microsoft.com/en-US/azure/app-service/">WebApp App Service</a></strong> has been created in Azure. The steps to follow would be:</p>
<ol class="simple">
<li><p>Login to Azure’s portal</p></li>
<li><p>Select App services and click on add.</p></li>
<li><p>Select Webapp and configure: Application Name, Subscription Type, Resource Group, OS Type, Publish Type, App Service Plan/Location and Application Insights</p></li>
</ol>
<p>Then, it has been taken into account that several environments have been created to work on the platform, that is, there will be different slots and the deployment of the code will be done in the corresponding one. All this has been explained in section 1 of this document.</p>
</div>
<div class="section" id="modules-communication">
<h3>2.4.1.2. Modules communication<a class="headerlink" href="#modules-communication" title="Permalink to this headline">¶</a></h3>
<p>For establish the communication:</p>
<ul class="simple">
<li><p>The client will make requests of the type:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">this</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">api</span><span class="o">+</span><span class="s1">&#39;/api/&#39;</span><span class="o">+&lt;</span><span class="n">url</span><span class="o">&gt;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">map</span><span class="p">(</span> <span class="p">(</span><span class="n">res</span> <span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="o">//</span> <span class="n">do</span> <span class="n">something</span> <span class="n">when</span> <span class="n">res</span> <span class="n">OK</span>
         <span class="p">},</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
           <span class="o">//</span> <span class="n">do</span> <span class="n">something</span> <span class="n">when</span> <span class="n">error</span>
         <span class="p">})</span>
</pre></div>
</div>
<ul class="simple">
<li><p>The server will listen to these requests and will perform the appropriate operations to give an answer to the client.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">api</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">&lt;</span><span class="n">url</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">auth</span><span class="p">,</span> <span class="n">function</span><span class="p">)</span>
</pre></div>
</div>
<p>This communication between components is done in a secure way, that is, several tools or techniques have been implemented so that the information is encrypted and the communication is reliable.
For this purpose, crypto libraries (aes-256-ecb) are used for data encryption and decryption, and jwt-simple for encoding the authentication token for API calls.</p>
<ul class="simple">
<li><p>Encryption: When a user tries to create an account, the pw is sha512 before it is sent to the server. On the server a jump is created using the bcrypt library and a hash is applied to it before it is stored. This password will never be returned as described in the database model (password: { type: String, select: false,…). On the other hand, in the login process, it is the data model itself that checks that the pw is valid (bcrypt.compare). If it exceeds a maximum of 5 attempts, the account is blocked for 2 hours.</p></li>
<li><p>Authentication token. All Methods APIs that have the authorization field in the header use Bearer authentication to restrict access to protected resources, , and always be sent next to a token. The bearer token is a cryptic string, generated by the server in response to a login request. Example of the header: Authorization: Bearer (token).<br />These requests can return some errors, such as the token is invalid, or has expired: { status: 401, message: “Token expired”} or { status: 401, message: “Invalid Token”}</p></li>
</ul>
<p>Health29 provides a Web API for accessing data. Anyone can develop an application to access and modify a Health29 user’s data. OAuth 2.0 (Implicit Grant) is used as an authorization protocol to give an API client limited access to user data.</p>
</div>
<div class="section" id="code-structure-client-structure">
<h3>2.4.1.3. Code Structure: Client Structure<a class="headerlink" href="#code-structure-client-structure" title="Permalink to this headline">¶</a></h3>
<p><em>NOTE: A template was purchased to have a base: <a class="reference external" href="https://themeforest.net/item/apex-angular-4-bootstrap-admin-template/20774875">Template Link</a>.</em></p>
<p>The structure is as follows:</p>
<p style="text-align: center;">
	<img width="800px" src="../../_images/H29_client_code.jpg">
</p><p>The src folder has the following:</p>
<ul>
<li><p>The <strong>app folder</strong> is the one with all the code.</p>
<blockquote>
<div><ul class="simple">
<li><p>app/app.component.{ts,html,css,spec.ts}: Defines the AppComponent along with an HTML template, CSS stylesheet, and a unit test. It is the root component of what will become a tree of nested components as the application evolves. In this file it is controlling the events of inactivity of a session, loading the language of the app depending on the language of the browser, the title that appears in the browser tab with the change of pages. If it is a mobile app, it also controls the backbutton, pause and resume events.</p></li>
<li><p>app/app.module.ts: Defines AppModule, the root module that tells Angular how to assemble the application.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>The <strong>assets folder</strong>: It contains all the information that will be accessible from any url. Css files, js, images, language files, jsons listing countries, types of subscriptions, frequently asked questions for each group of patients, etc. It will be the only visible folder when a build is made for production.</p></li>
<li><p>The <strong>environments folder</strong>. This folder contains one file for each of your destination environments, each exporting simple configuration variables to use in your application. The files are replaced on-the-fly when you build your app. You might use a different API endpoint for development than you do for production or maybe different analytics tokens. You might even use some mock services. Either way, the CLI has you covered. At the moment url of the api, and fitbit credentials</p></li>
<li><p><strong>Some files</strong>:</p></li>
</ul>
<blockquote>
<div><ul class="simple">
<li><p>favicon.ico: Every site wants to look good on the bookmark bar. Get started with your very own Angular icon</p></li>
<li><p>index.html: The main HTML page that is served when someone visits your site. Most of the time you’ll never need to edit it. The CLI automatically adds all js and css files when building your app so you never need to add any script or link tags here manually. For the mobile version, two small changes must be made in this file:
Change base: base href=”./”
Add cordova:  “script src=”cordova.js”</p></li>
<li><p>main.ts: The main entry point for your app. Compiles the application with the JIT compiler and bootstraps the application’s root module (AppModule) to run in the browser. You can also use the AOT compiler without changing any code by passing in –aot to ng build or ng serve</p></li>
<li><p>polyfills.ts: Different browsers have different levels of support of the web standards. Polyfills help normalize those differences. You should be pretty safe with core-js and zone.js, but be sure to check out the Browser Support guide for more information.</p></li>
<li><p>styles.css: Your global styles go here. Most of the time you’ll want to have local styles in your components for easier maintenance, but styles that affect all of your app need to be in a central place.</p></li>
<li><p>test.ts: This is the main entry point for your unit tests. It has some custom configuration that might be unfamiliar, but it’s not something you’ll need to edit.</p></li>
<li><p>tsconfig.{app|spec}.json: TypeScript compiler configuration for the Angular app (tsconfig.app.json) and for the unit tests (tsconfig.spec.json).</p></li>
</ul>
</div></blockquote>
<p>The <strong>app folder</strong> is the one with all the code:</p>
<p style="text-align: center;">
	<img width="800px" src="../../_images/Health29_client_code_app.jpg">
</p><ul class="simple">
<li><p><strong>Layouts</strong>: the different layouts that there are, at the moment two subfolders, for the logged ones (full) and for the ones that are not (content).</p></li>
<li><p><strong>Pages</strong>: It has two subfolders, content-pages (corresponds to the logged out pages like login page, registration, etc) and full-pages (common pages for all logged out roles, like the user-profile page).</p></li>
<li><p><strong>Role pages</strong></p></li>
</ul>
<blockquote>
<div><ul class="simple">
<li><p><em>admin</em>: contains all pages for the admin role</p></li>
<li><p><em>superadmin</em>: contains all pages for the superadmin role</p></li>
<li><p><em>clinical</em>: contains all pages for the clinical role</p></li>
<li><p><em>user</em>: contains all the pages for the user role.
Each folder of these roles has a module file (it loads the needed modules), and a route file to manage the routes and control the authentication and authorization (auth-guard and role-guard)</p></li>
</ul>
</div></blockquote>
<ul class="simple">
<li><p>The <strong>shared folder</strong>, which is the shared code:</p></li>
</ul>
<blockquote>
<div><ul class="simple">
<li><p>auth: The Auth folder includes the services that will handle the platform’s authentication and authorization tasks. Thus, this folder will contain: authorization management (role-guard), authentication (auth-service and auth-guard), control of headers in the application’s http communications
(http interceptor),page routing control(canDeactivate) and oauth.services for external services like fitbit.</p></li>
<li><p>Configs: configuration files, for example configuration for toasts, or parameters for graphs.</p></li>
<li><p>Customizer: This is the customizer or chatbot component of the platform. At the moment it’s only implemented for the user profile, but it’s exposed as a shared module in case you want to include this functionality in some other profile in the future.</p></li>
<li><p>Directives: correspond to the Angular directives</p></li>
<li><p>Footer: It’s the footer component of the platform.</p></li>
<li><p>Models: Here you can add the data models you want to use on the platform that are common to all profiles. At the moment only the FAQ template is added.</p></li>
<li><p>Navbar and navbar-nolog: It corresponds to the top bar. Navbar-nolog is for when you are not logged in.</p></li>
<li><p>Routes: route management. It has two files, one for the paths of the unlogged pages, and another for the rest.</p></li>
<li><p>Services: corresponds to the Angular services. Several have been developed as faq.service or lang.service</p></li>
<li><p>Sidebar: side menu, depending on the role, loads one menu or another.</p></li>
</ul>
</div></blockquote>
<p><strong>Routes</strong>: In the root of the app folder, there is a file called app-routing.module.ts, which is the root of the routes management. Depending on the path, it loads some subroutes and others. For example, if it is unlogged, it loads the routes ./shared/routes/content-layout.routes, on the other hand, if it is logged in it loads ./shared/routes/full-layout.routes. In this second case, check that it is authenticated (canActivate: [AuthGuard])
The rest of the subroutes that come from full-layout, are controlled if they are logged and authenticated in the routing-module file of each module (each profile has a module) with canActivate: [AuthGuard, RoleGuard].</p>
</div>
<div class="section" id="code-structure-server-structure">
<h3>2.4.1.4. Code Structure: Server Structure<a class="headerlink" href="#code-structure-server-structure" title="Permalink to this headline">¶</a></h3>
<p style="text-align: center;">
  <img width="800px" src="../../_images/H29_server_code.jpg">
</p><ul class="simple">
<li><p>The <strong>dist folder</strong> contains the compilation of the client code.</p></li>
<li><p>In the <strong>models folder</strong>, the different templates for working with the platform’s database collections are defined.</p></li>
<li><p>The <strong>controllers folder</strong> contains the functionality to work with the previous collections. It is organized according to the actions that each role of the health29 platform can perform.</p></li>
<li><p>In the <strong>routes folder</strong>, all the routes of the api appear. It contains the file index.js that links the models with the controllers, defining the requests that will be available to the Health29 client. Those that have auth means that they need authorization to be used.</p></li>
<li><p><strong>Middlewares</strong> has the file auth.js which is in charge of checking if the token is valid, so that you know if you have permission to make the request to the API call.</p></li>
<li><p>In <strong>views</strong> we have the views generated by the server and the templates for the emails.</p></li>
<li><p>Analogous to the client structure we have the <strong>services folder</strong>. Here, we have the following services: Auth.js creates and decodes token, crypt.js encrypts and decrypts data and email.js is the emailing service. There are also other services for exomizer and phenolizer functions.</p></li>
<li><p><strong>Some files</strong>:</p></li>
</ul>
<blockquote>
<div><ul class="simple">
<li><p>index.js: file where the app.js and config.js file is loaded It listens to requests.</p></li>
<li><p>Config.js: configuration file. The server url, port, connection with the data bases are passed to it through environment variables. The credentials of the mail that send email, the secret token of jwt, and the secret of crypto are not passed through environment variables.</p></li>
<li><p>Db_connect.js: will be in charge of creating the connection with the databases.</p></li>
<li><p>App.js: the crossdomain is established, and other node configurations. It manages the requests, and these can be of 3 types:
&gt;1. API routes managed by routes folder.
&gt;2. Server-generated view paths (handlebars)
&gt;3. the paths of the Angular client application (dist folder)</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="external-libraries-and-dependencies">
<h3>2.4.1.4. External libraries and dependencies<a class="headerlink" href="#external-libraries-and-dependencies" title="Permalink to this headline">¶</a></h3>
<p>All the necessary dependencies or libraries that will be used in the implementation of the application can be checked in the “package.json” files of both the client and the server. The installation of all these libraries and dependencies has been done with <a class="reference external" href="https://docs.npmjs.com/using-npm-packages-in-your-projects">npm</a>, which updates the “Node modules” folder with the necessary packages to work with. Therefore, when you want to work with the projects, it is necessary to execute previously the command “npm install”.</p>
<p>On the one hand, among all those found in this file, we can mainly highlight that the versions are being used:</p>
<ul class="simple">
<li><p>Both client and server:</p></li>
</ul>
<blockquote>
<div><ul class="simple">
<li><p>v10.16.3 of node.</p></li>
<li><p>0.11.4 of botframework-webchat</p></li>
</ul>
</div></blockquote>
<ul class="simple">
<li><p>For the client:</p></li>
</ul>
<blockquote>
<div><ul class="simple">
<li><p>1.7.0 of Angular CLI and 5.2.5 of the node modules Angular libraries (Angular 5).</p></li>
<li><p>2.6.2 of TypeScript.</p></li>
<li><p>1.0.0 of ng-bootstrap</p></li>
<li><p>Jquery 3.2.1</p></li>
</ul>
</div></blockquote>
<ul class="simple">
<li><p>For the server:</p></li>
</ul>
<blockquote>
<div><ul class="simple">
<li><p>1.12.1 of nodemon</p></li>
<li><p>4.16.2 of express and 3.0.0 of express-handlebars</p></li>
<li><p>4.13.1 moongose</p></li>
<li><p>2.6.0 of async</p></li>
</ul>
</div></blockquote>
<p>On the other hand, specific NPM libraries have been installed for some functionalities:</p>
<ul class="simple">
<li><p>For the client:</p></li>
</ul>
<blockquote>
<div><ul class="simple">
<li><p>For the HTTP requests, the version 1.0.0-beta.2 of the library <a class="reference external" href="https://www.npmjs.com/package/&#64;auth0/angular-jwt">&#64;auth0/angular-jwt</a> is used</p></li>
<li><p>For graphic representations <a class="reference external" href="https://www.npmjs.com/package/d3">d3</a> has been installed. Version 5.7.1 of &#64;types/d3 and 1.2.2 of &#64;types/d3-shape</p></li>
<li><p>Fingerprint2 version 2.0.0 (https://www.npmjs.com/package/fingerprintjs2) is used to obtain the information of the device being used to access the platform.</p></li>
<li><p>Version 0.24.1 of <a class="reference external" href="https://www.npmjs.com/package/angular-calendar">angular-calendar</a> is used to work with the date entries of the platform.</p></li>
<li><p>For data encryption, version 0.7.1 of <a class="reference external" href="https://www.npmjs.com/package/js-sha512">js-sha512</a> is used and for the reverse process, version 2.2.0 of <a class="reference external" href="https://www.npmjs.com/package/jwt-decode">jwt-decode</a> is used.</p></li>
<li><p>Version 7.12.9 of <a class="reference external" href="https://www.npmjs.com/package/sweetalert2">sweetalert2</a> is used for platform popups.</p></li>
</ul>
</div></blockquote>
<ul class="simple">
<li><p>For the server</p></li>
</ul>
<blockquote>
<div><ul class="simple">
<li><p>For emailing tasks: 4.4.0 nodemailer and 2.0.0 nodemailer-express-handlebars.</p></li>
<li><p>For communication with Azure: 0.10.6 of azure-sb</p></li>
<li><p>To use the Authy application as 2FA: 1.4.0 of authy and 1.1.4 of authy-client</p></li>
<li><p>For data encryption, version 0.7.0 of <a class="reference external" href="https://www.npmjs.com/package/js-sha512">js-sha512</a> is used</p></li>
</ul>
</div></blockquote>
<p>In addition to this, Javascript scripts and JSON files have been added as libraries to optimize the programming of different functionalities for the client:</p>
<ul class="simple">
<li><p>Javascript scripts:</p></li>
</ul>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="http://hilios.github.io/jQuery.countdown/">Jquery countdown</a></p></li>
<li><p><a class="reference external" href="https://www.npmjs.com/package/pdfjs">PDF JS</a></p></li>
<li><p><a class="reference external" href="https://www.npmjs.com/package/&#64;azure/storage-blob">Azure storage</a></p></li>
</ul>
</div></blockquote>
<ul class="simple">
<li><p>JSON Files located in src/assets/jsons:</p></li>
</ul>
<blockquote>
<div><ul class="simple">
<li><p>Some JSON files for managing the users’ location information (country, province, cities and phone codes): Countries folder, cities.json, countries.json, countries_nl.json and phone_codes.json</p></li>
<li><p>Some JSON files for obtain and manage the symptons: genes_to_phenotype.json, orpha-omim-orpha.json, orphaids.json and phenotypes.json.</p></li>
<li><p>A JSON with the languages available in Azure Cognitive Service for translation tasks: cognitive-services-languages.json</p></li>
<li><p>A JSON for the management of languages available on the platform: all-languages.json</p></li>
<li><p>A JSON for the types of subscription on the platform: subscription-types.json</p></li>
</ul>
</div></blockquote>
</div>
</div>
<div class="section" id="external-apis">
<h2>2.4.2. External APIs<a class="headerlink" href="#external-apis" title="Permalink to this headline">¶</a></h2>
<p><strong>API Foundation29</strong> has been designed to act as an intermediary between the webapp and Azure Qnamaker’s service.
The functions that have been implemented to perform actions on the Azure service are analogous to those in the <a class="reference external" href="https://docs.microsoft.com/en-us/azure/cognitive-services/qnamaker/quickstarts/quickstart-rest-curl">Azure documentation</a>.</p>
<p>It can be consulted at the following link: <a class="reference external" href="https://f29api.northeurope.cloudapp.azure.com/index.html">API Foundation29</a>.
And the functionality and methodology of use is described in the qnamaker section of this document (2.4.3.2. Qna maker)</p>
<p>Some functions to use the monarch API from this have also been included in this API. But this is not being used at the moment in health29 and the calls to the <strong>monarch API</strong> are executed directly, without intermediaries.</p>
<ul class="simple">
<li><p>Request for list of related conditions</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>request({
url: https://api.monarchinitiative.org/api/sim/search?is_feature_set=true&amp;metric=phenodigm&amp;id=HP:0001250&amp;id=HP:0002133&amp;limit=100&amp;taxon=9606’,
json: true
}
</pre></div>
</div>
<ul class="simple">
<li><p>To open a new link for information on a symptom</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">href</span><span class="o">=</span><span class="s2">&quot;https://monarchinitiative.org/phenotype/&#39;+res[j].id+&#39;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>To obtain information about a disease:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>href=”https://monarchinitiative.org/disease/{{value.id}}#overview
</pre></div>
</div>
<p>And with this API, the configuration of the headers (auth.interceptor.ts) to establish the connection with Azure’s service are sent are like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">indexOf</span><span class="p">(</span><span class="s1">&#39;https://api.monarchinitiative.org/api/&#39;</span><span class="p">)</span><span class="o">!==-</span><span class="mi">1</span><span class="p">){</span>
  <span class="n">isExternalReq</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="azure-cognitive-services">
<h2>2.4.3. Azure cognitive services<a class="headerlink" href="#azure-cognitive-services" title="Permalink to this headline">¶</a></h2>
<div class="section" id="computer-vision">
<h3>2.4.3.1. Computer Vision<a class="headerlink" href="#computer-vision" title="Permalink to this headline">¶</a></h3>
<p>To create it from azure you just have to select the cognitive service in the marketplace: “ComputerVision”.
The configuration has no complexity, just select the Price tier and the resource group.</p>
<p>It is used in the webapp client, as it has been indicated until now, establishing a REST communication:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">this</span><span class="o">.</span><span class="n">subscription</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">this</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;https://westeurope.api.cognitive.microsoft.com/vision/v1.0/ocr?language=&#39;</span><span class="o">+</span><span class="n">this</span><span class="o">.</span><span class="n">cognitiveServicesLanguage</span> <span class="o">+</span><span class="s1">&#39;&amp;detectOrientation=true&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="o">.</span><span class="n">subscribe</span><span class="p">(</span> <span class="p">(</span><span class="n">res</span> <span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    	<span class="o">//</span> <span class="n">Do</span> <span class="n">something</span> <span class="n">when</span> <span class="n">result</span> <span class="n">OK</span>
	<span class="p">},</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
     <span class="o">//</span> <span class="n">Do</span> <span class="n">something</span> <span class="n">when</span> <span class="n">error</span>
<span class="p">}));</span>
</pre></div>
</div>
<p>And the configuration of the headers (auth.interceptor.ts) to use this service is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">indexOf</span><span class="p">(</span><span class="s1">&#39;api.cognitive.microsoft.com/vision&#39;</span><span class="p">)</span><span class="o">!==-</span><span class="mi">1</span><span class="p">){</span>
  <span class="n">isExternalReq</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
  <span class="n">const</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">new</span> <span class="n">HttpHeaders</span><span class="p">({</span>
    <span class="s1">&#39;Ocp-Apim-Subscription-Key&#39;</span><span class="p">:</span> <span class="s1">&#39;992ab4c1c5ff4412a052b0d170feeab8&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/octet-stream&#39;</span>
  <span class="p">});</span>
  <span class="n">authReq</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">clone</span><span class="p">({</span> <span class="n">headers</span><span class="p">});</span><span class="o">//</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span>  <span class="s1">&#39;application/json&#39;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As it has been said before this is used for the symptom extraction, so the call is made in phenotypes.component.ts.</p>
<p>All the commands and settings for establishing this communication are described in the <a class="reference external" href="https://docs.microsoft.com/bs-latn-ba/azure/cognitive-services/computer-vision/vision-api-how-to-topics/howtocallvisionapi">Microsoft documentation</a>.</p>
</div>
<div class="section" id="qna-maker">
<h3>2.4.3.2. Qna maker<a class="headerlink" href="#qna-maker" title="Permalink to this headline">¶</a></h3>
<p>To create it from azure you just have to select the cognitive service in the marketplace: “Qna maker”.
The configuration has no complexity, just:</p>
<ul class="simple">
<li><p>Enter a name</p></li>
<li><p>Select subscription of Azure, the Price tier, the resource group adn the localization.</p></li>
<li><p>Enter an application name for establish the url: “app_name.azurewebsites.net”</p></li>
</ul>
<p>As previously stated, in Health29 it is used to manage the FAQs in different ways and from different points of the platform. To work with the data of this azure service, an external API will be used as an intermediary: f29API, described in the previous section, so that all calls will be made to it.</p>
<p style="text-align: center;">
	<img width="400px" src="../../_images/F29API_code.jpg">
</p><p>First, the Qna Maker Knowledge base ID, which the webapp wants to access (according to patient group and language), is queried in the qna collection.
With this ID it is possible to make requests to F29 API to obtain, modify or delete elements from the database.</p>
<p>However, the same format has been used as if the calls were made directly to Azure’s service, as an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">this</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://f29api.northeurope.cloudapp.azure.com/api/knowledgebases/&#39;</span><span class="o">+</span><span class="n">knowledgeBaseID</span><span class="o">+</span><span class="s1">&#39;/Prod/qna&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">map</span><span class="p">(</span> <span class="p">(</span><span class="n">res</span> <span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="o">//</span> <span class="n">Do</span> <span class="n">something</span> <span class="n">when</span> <span class="n">get</span> <span class="n">the</span> <span class="n">Knoledbase</span> <span class="n">information</span>
	<span class="p">},</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
     <span class="o">//</span> <span class="n">Do</span> <span class="n">something</span> <span class="n">when</span> <span class="n">error</span>
<span class="p">}));</span>
</pre></div>
</div>
<p>And with the configuration of the headers (auth.interceptor.ts) to use this service the same thing happens, the ones that would be necessary to establish the connection with Azure’s service are sent:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">indexOf</span><span class="p">(</span><span class="s1">&#39;https://f29api.northeurope.cloudapp.azure.com&#39;</span><span class="p">)</span><span class="o">!==-</span><span class="mi">1</span><span class="p">){</span>
  <span class="n">isExternalReq</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
  <span class="n">const</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">new</span> <span class="n">HttpHeaders</span><span class="p">({</span>
    <span class="s1">&#39;Ocp-Apim-Subscription-Key&#39;</span><span class="p">:</span> <span class="s1">&#39;8d7bca89da4e42c1bf79b292207c9635&#39;</span>
  <span class="p">});</span>
  <span class="n">authReq</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">clone</span><span class="p">({</span> <span class="n">headers</span><span class="p">});</span>
<span class="p">}</span>
</pre></div>
</div>
<p>All the commands and settings for establishing this communication are described in the <a class="reference external" href="https://docs.microsoft.com/en-us/azure/cognitive-services/qnamaker/quickstarts/quickstart-rest-curl">Microsoft documentation</a>.</p>
</div>
<div class="section" id="translator">
<h3>2.4.3.3. Translator<a class="headerlink" href="#translator" title="Permalink to this headline">¶</a></h3>
<p>To create it from azure you just have to select the cognitive service in the marketplace: “Translator text”.
The configuration has no complexity, just select the Price tier and the resource group.</p>
<p>It is used in the webapp client, as it has been indicated until now, establishing a REST communication:</p>
<ul class="simple">
<li><p>First case: communication without authorization required.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">this</span><span class="o">.</span><span class="n">subscription</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">this</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;https://api.cognitive.microsofttranslator.com/translate?api-version=3.0&amp;to=&#39;</span><span class="o">+</span><span class="n">this</span><span class="o">.</span><span class="n">authService</span><span class="o">.</span><span class="n">getLang</span><span class="p">(),</span> <span class="n">jsonText</span><span class="p">)</span>
    <span class="o">.</span><span class="n">subscribe</span><span class="p">(</span> <span class="p">(</span><span class="n">res</span> <span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    	<span class="o">//</span> <span class="n">Do</span> <span class="n">something</span> <span class="n">when</span> <span class="n">it</span> <span class="n">returns</span> <span class="n">the</span> <span class="n">text</span> <span class="kn">from</span> <span class="nn">jsonText</span> <span class="n">translated</span>
    <span class="p">},</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
       <span class="o">//</span> <span class="n">Do</span> <span class="n">something</span> <span class="n">when</span> <span class="n">error</span>
    <span class="p">}));</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Second case: communication with authorization required.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">this</span><span class="o">.</span><span class="n">subscription</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">this</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;https://api.cognitive.microsoft.com/sts/v1.0/issueToken&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">subscribe</span><span class="p">(</span> <span class="p">(</span><span class="n">res</span> <span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      	<span class="o">//</span> <span class="n">get</span> <span class="n">the</span> <span class="n">token</span> <span class="k">for</span> <span class="n">establish</span> <span class="n">communication</span> <span class="n">between</span> <span class="n">webapp</span> <span class="ow">and</span> <span class="n">text</span> <span class="n">translator</span>
        <span class="n">sessionStorage</span><span class="o">.</span><span class="n">setItem</span><span class="p">(</span><span class="s1">&#39;tokenMicrosoftTranslator&#39;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="p">},</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
	 	<span class="o">//</span> <span class="n">Do</span> <span class="n">something</span> <span class="n">when</span> <span class="n">error</span>
	<span class="p">}));</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">this</span><span class="o">.</span><span class="n">subscription</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">this</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://api.microsofttranslator.com/V2/Http.svc/Translate?appid=Bearer&#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">sessionStorage</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="s1">&#39;tokenMicrosoftTranslator&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;&amp;text=&#39;</span><span class="o">+&lt;</span><span class="n">text</span><span class="o">&gt;+</span><span class="s1">&#39;&amp;to=en&amp;Authorization=Bearer&#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">sessionStorage</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="s1">&#39;tokenMicrosoftTranslator&#39;</span><span class="p">))</span>
	<span class="o">.</span><span class="n">subscribe</span><span class="p">(</span> <span class="p">(</span><span class="n">res</span> <span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
		<span class="o">//</span> <span class="n">Do</span> <span class="n">something</span> <span class="n">when</span> <span class="n">it</span> <span class="n">returns</span> <span class="n">the</span> <span class="n">text</span> <span class="kn">from</span> <span class="o">&lt;</span><span class="n">text</span><span class="o">&gt;</span> <span class="n">translated</span>
	<span class="p">},</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
	 	<span class="o">//</span> <span class="n">Do</span> <span class="n">something</span> <span class="n">when</span> <span class="n">error</span>
	<span class="p">}));</span>
</pre></div>
</div>
<p>And the configuration of the headers (auth.interceptor.ts) to use this service is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">indexOf</span><span class="p">(</span><span class="s1">&#39;https://api.cognitive.microsoft.com/sts/v1.0/issueToken&#39;</span><span class="p">)</span><span class="o">!==-</span><span class="mi">1</span><span class="p">){</span>
  <span class="n">isExternalReq</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
  <span class="n">authReq</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">clone</span><span class="p">({</span> <span class="n">headers</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;Ocp-Apim-Subscription-Key&#39;</span><span class="p">,</span>  <span class="s1">&#39;7174b790ef59409280f77dd94c34a9d2&#39;</span> <span class="p">),</span> <span class="n">responseType</span><span class="p">:</span> <span class="s1">&#39;text&#39;</span><span class="p">});</span>
<span class="p">}</span>

<span class="k">if</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">indexOf</span><span class="p">(</span><span class="s1">&#39;https://api.microsofttranslator.com&#39;</span><span class="p">)</span><span class="o">!==-</span><span class="mi">1</span><span class="p">){</span>
  <span class="n">isExternalReq</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
  <span class="n">authReq</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">clone</span><span class="p">({</span> <span class="n">responseType</span><span class="p">:</span> <span class="s1">&#39;text&#39;</span> <span class="p">});</span>
<span class="p">}</span>
<span class="k">if</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">indexOf</span><span class="p">(</span><span class="s1">&#39;https://api.cognitive.microsofttranslator.com&#39;</span><span class="p">)</span><span class="o">!==-</span><span class="mi">1</span><span class="p">){</span>
  <span class="n">isExternalReq</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
  <span class="n">authReq</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">clone</span><span class="p">({</span> <span class="n">headers</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;Ocp-Apim-Subscription-Key&#39;</span><span class="p">,</span>  <span class="s1">&#39;7174b790ef59409280f77dd94c34a9d2&#39;</span> <span class="p">)</span> <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The first of these is used to translate the datapoints and to add a new language to the platform, while the second is used in the symptom section (phenotype) to translate into English the text obtained from the vision service.</p>
<p>All the commands and settings for establishing this communication are described in the <a class="reference external" href="https://docs.microsoft.com/bs-cyrl-ba/azure/cognitive-services/translator/">Microsoft documentation</a>.</p>
</div>
</div>
<div class="section" id="azure-healthbot">
<h2>2.4.4. Azure Healthbot<a class="headerlink" href="#azure-healthbot" title="Permalink to this headline">¶</a></h2>
<p>To create it from azure you just have to select the Healthcare Bot in the marketplace.
To create and configure it, just follow the steps in the <a class="reference external" href="https://docs.microsoft.com/en-us/healthbot/quickstart-createyourhealthcarebot">Microsoft guide</a>.</p>
<p>In the case of Health29, the App service <a class="reference external" href="https://healthbotcontainersamplef666.scm.azurewebsites.net/dev/wwwroot/server.js">server</a> has been configured to be able to deploy the three bots depending on the webapp client that is running it. So that:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">var</span> <span class="n">WEBCHAT_SECRET</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">WEBCHAT_SECRET</span><span class="p">;</span>
<span class="n">var</span> <span class="n">APP_SECRET</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">APP_SECRET</span><span class="p">;</span>
<span class="k">if</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="s1">&#39;https://health29.org&#39;</span><span class="p">){</span>

<span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="s1">&#39;https://health29-test.azurewebsites.net&#39;</span><span class="p">){</span>
    <span class="n">WEBCHAT_SECRET</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">WEBCHAT_SECRET_TEST</span><span class="p">;</span>
    <span class="n">APP_SECRET</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">APP_SECRET_TEST</span><span class="p">;</span>
<span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="s1">&#39;http://localhost:4200&#39;</span> <span class="o">||</span> <span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span><span class="s1">&#39;https://health29-dev.azurewebsites.net&#39;</span><span class="p">){</span>
    <span class="n">WEBCHAT_SECRET</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">WEBCHAT_SECRET_DEV</span><span class="p">;</span>
    <span class="n">APP_SECRET</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">APP_SECRET_DEV</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>It should be noted that this service has a monthly message limit. Depending on the rate chosen in each of the Healthbots, a greater or lesser flow of information exchange or interactions of the Health29 assistant will be allowed.</p>
<p><em>NOTE: if at any time the limit is exceeded, the bot will return error 429 (Too many request).</em></p>
<p>The incorporation of this assistant to the webapp is done from the client, in particular, from the customizer component.
This way, it is added to the HTML:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">div</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;botContainer&quot;</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;width:95%&quot;</span><span class="o">&gt;&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>And the style is added from the scss file.</p>
<p>As for the functionality of the bot, this is included in the “.ts” file, taking into account:</p>
<p style="text-align: center;">
	<img width="800px" src="../../_images/botflow.png">
</p><p>Health Bot uses <a class="reference external" href="https://dev.botframework.com/">Bot Framework</a> under the hood as a messaging and routing platform to deliver messages to and from the end user.</p>
<p>So, the steps to follow are:</p>
<ol class="simple">
<li><p>Get the token for the connection with the azure service:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">var</span> <span class="n">paramssend</span> <span class="o">=</span> <span class="p">{</span> <span class="n">userName</span><span class="p">:</span> <span class="n">this</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">userName</span><span class="p">,</span> <span class="n">userId</span><span class="p">:</span> <span class="n">this</span><span class="o">.</span><span class="n">authService</span><span class="o">.</span><span class="n">getIdUser</span><span class="p">(),</span> <span class="n">token</span><span class="p">:</span> <span class="n">this</span><span class="o">.</span><span class="n">authService</span><span class="o">.</span><span class="n">getToken</span><span class="p">(),</span> <span class="n">groupId</span><span class="p">:</span> <span class="n">this</span><span class="o">.</span><span class="n">groupId</span><span class="p">,</span> <span class="n">lang</span><span class="p">:</span> <span class="n">this</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">lang</span><span class="p">,</span> <span class="n">knowledgeBaseID</span><span class="p">:</span> <span class="n">this</span><span class="o">.</span><span class="n">knowledgeBaseID</span><span class="p">};</span>
<span class="n">this</span><span class="o">.</span><span class="n">subscription</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">this</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://healthbotcontainersamplef666.azurewebsites.net:443/chatBot&#39;</span><span class="p">,{</span><span class="n">params</span><span class="p">:</span> <span class="n">paramssend</span><span class="p">})</span>
	<span class="o">.</span><span class="n">subscribe</span><span class="p">(</span> <span class="p">(</span><span class="n">res</span> <span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
		<span class="o">//</span> <span class="n">Get</span> <span class="n">the</span> <span class="n">token</span> <span class="n">OK</span>
	<span class="p">},</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
		<span class="o">//</span> <span class="n">Get</span> <span class="n">the</span> <span class="n">token</span> <span class="n">Error</span>
<span class="p">}));</span>
</pre></div>
</div>
<ol class="simple">
<li><p>Create a bot connection:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">jsonWebToken</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
<span class="n">const</span> <span class="n">tokenPayload</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">atob</span><span class="p">(</span><span class="n">jsonWebToken</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]));</span>
<span class="n">const</span> <span class="n">user</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nb">id</span><span class="p">:</span> <span class="n">tokenPayload</span><span class="o">.</span><span class="n">userId</span><span class="p">,</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">tokenPayload</span><span class="o">.</span><span class="n">userName</span>
<span class="p">};</span>
<span class="n">const</span> <span class="n">botConnection</span> <span class="o">=</span> <span class="n">new</span> <span class="n">BotChat</span><span class="o">.</span><span class="n">DirectLine</span><span class="p">({</span>
  <span class="o">//</span><span class="n">secret</span><span class="p">:</span> <span class="n">botSecret</span><span class="p">,</span>
  <span class="n">token</span><span class="p">:</span> <span class="n">tokenPayload</span><span class="o">.</span><span class="n">connectorToken</span><span class="p">,</span>
  <span class="o">//</span><span class="n">domain</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
  <span class="n">webSocket</span><span class="p">:</span> <span class="n">true</span>
<span class="p">});</span>
</pre></div>
</div>
<ol class="simple">
<li><p>Start conversation</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>const botContainer = document.getElementById(&#39;botContainer&#39;);
$(&#39;#botContainer&#39;).empty();
botContainer.classList.add(&quot;wc-display&quot;);
BotChat.App({
    botConnection: botConnection,
    user: user,
    locale: this.user.lang,
    bot: {id: &#39;&#39;},//id: &#39;h29bot-giochop&#39; //id: &#39;zebrahealthbot&#39;
    resize: &#39;detect&#39;
    // sendTyping: true,    // defaults to false. set to true to send &#39;typing&#39; activities to bot (and other users) when user is typing
}, botContainer);
</pre></div>
</div>
<ol class="simple">
<li><p>A communication will be established with it to exchange information and perform the relevant actions:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">this</span><span class="o">.</span><span class="n">subscription</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">botConnection</span><span class="o">.</span><span class="n">postActivity</span><span class="p">({</span><span class="nb">type</span><span class="p">:</span> <span class="s2">&quot;event&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">jsonWebToken</span><span class="p">,</span> <span class="n">from</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;InitAuthenticatedConversation&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">function</span> <span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="p">{</span>
     <span class="o">//</span> <span class="n">Start</span> <span class="n">scenarios</span>
<span class="p">},</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
		<span class="o">//</span> <span class="n">Do</span> <span class="n">something</span> <span class="n">when</span> <span class="n">error</span>
<span class="p">}));</span>
</pre></div>
</div>
<p>All the commands and settings for using this Healthbot service ara available in <a class="reference external" href="https://docs.microsoft.com/en-us/healthbot/integrations/embed">Microsoft documentation</a>.</p>
<p>In addition to this, the HTTP headers have to be configured to be able to use this service in the auth.interceptor.ts file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">indexOf</span><span class="p">(</span><span class="s1">&#39;healthbot&#39;</span><span class="p">)</span><span class="o">!==-</span><span class="mi">1</span><span class="p">){</span>
  <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;epasa&#39;</span><span class="p">);</span>
  <span class="n">isExternalReq</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
  <span class="n">const</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">new</span> <span class="n">HttpHeaders</span><span class="p">({</span>
    <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span>  <span class="s1">&#39;text/html; charset=utf-8&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Access-Control-Allow-Methods&#39;</span><span class="p">:</span> <span class="s1">&#39;GET&#39;</span>
  <span class="p">});</span>
  <span class="n">authReq</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">clone</span><span class="p">({</span> <span class="n">headers</span><span class="p">,</span> <span class="n">responseType</span><span class="p">:</span> <span class="s1">&#39;text&#39;</span><span class="p">});</span><span class="o">//</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span>  <span class="s1">&#39;application/json&#39;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As already indicated, once the bot is embedded in the webapp you will have to indicate it to initialize the desired scenarios in each case. These scenarios are designed, implemented and configured in:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://us.healthbot.microsoft.com/account/zebrahealthbot/scenarios/manage">Healthbot</a> of the development environment.</p></li>
<li><p><a class="reference external" href="https://eu.healthbot.microsoft.com/account/healthbot-test-tjo3h51/scenarios/manage">Healthbot</a> of the test environment.</p></li>
<li><p><a class="reference external" href="https://eu.healthbot.microsoft.com/account/h29bot-giochop/scenarios/manage">Healthbot</a> of the production environment.</p></li>
</ul>
<p>In the microsoft documentation there are <a class="reference external" href="https://docs.microsoft.com/en-us/healthbot/quickstart-createyourfirstscenario">guides</a> to help you create these scenarios.</p>
<p>The general workflow of the Healthbot scenarios defined for Health29 is</p>
<p style="text-align: center;">
	<img width="800px" src="../../_images/Scenarios.jpg">
</p><p>Different scenarios could be designed for each patient group. Thus, for example, the flow of the main scenario of the Health29 assistant for the Duchenne group can be schematized as:</p>
<p style="text-align: center;">
	<img width="800px" src="../../_images/botscenarios.jpg">
</p><p>Except for the control scenarios that do not send messages to the user, the rest are replicated: one is created per user language available in Health29 (as can be seen in the previous diagram, the nomenclature “scenarioName_lang” has been used).
In this way, the scenarios that will be executed depend on the language selected by the user on the Health29 platform.</p>
<p>A modification of this was started to use the Healthbot localization service to avoid scenario replications. However, there is still work to be done since this translation could not be managed for some messages sent by the bot to notify of problems or errors. This has been solved so far from the Health29 client code.
For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> if((activity.text ===&quot;I didn&#39;t understand. Please choose an option from the list.&quot;)){
  var x = document.getElementsByClassName(&quot;format-markdown&quot;);
  for (var element=0;element&lt;x.length;element++){
    var stringElement=x[element].firstElementChild.childNodes[0].textContent;
    if((stringElement ==&quot;I didn’t understand. Please choose an option from the list.&quot;)||
    (stringElement==&quot;No se pudo reconocer su respuesta. Por favor seleccione una opción de la lista.&quot;)){
      var tempElement=x[element].firstElementChild.childNodes[0];
      tempElement.textContent = this.translate.instant(&quot;generics.Understand&quot;);
      $(x[element].firstElementChild.childNodes[0]).replaceWith(tempElement.textContent);
    }
  }
</pre></div>
</div>
<p>In this case, the messages shown by the bot are read and translated using the translation system used in Health29 that is explained in the “Multilanguage” section of this document.</p>
<p>Finally, it should also be noted that an action flow has been defined for the task of closing or minimizing the platform’s assistant, taking into account that</p>
<ul class="simple">
<li><p>This will be displayed whenever a user logs in.</p></li>
<li><p>The user will be given the option to end the conversation, so previous messages will be deleted and the wizard will be minimized.</p></li>
<li><p>The behavior of the buttons to maximize/minimize and open/close the assistant in Health29 is maintained.</p></li>
</ul>
</div>
<div class="section" id="azure-blobs">
<h2>2.4.5. Azure blobs<a class="headerlink" href="#azure-blobs" title="Permalink to this headline">¶</a></h2>
<p>To create it from azure you just have to search in the marketplace: “Storage account”.
The configuration has no complexity,</p>
<ul class="simple">
<li><p>Fill project details: subscription and resource group</p></li>
<li><p>Fill instance details:</p></li>
</ul>
<blockquote>
<div><ul class="simple">
<li><p>Storage account name</p></li>
<li><p>Localization</p></li>
<li><p>Performance (default standard)</p></li>
<li><p>Account kind (blobstorage)</p></li>
<li><p>Replication</p></li>
<li><p>Access tier (hot)</p></li>
</ul>
</div></blockquote>
<p>It is used in the webapp client establishing a REST communication.
In this project, the Javascript library Azure storage is used. In this way, some services have been created in the client project of Angular that will allow working with the reading and writing functions of the Azure blob.
Thus, the following services have been defined:</p>
<ul class="simple">
<li><p>blob-storage-medical-care.service.ts</p></li>
<li><p>blob-storage-support.service.ts</p></li>
<li><p>blob-storage.service.ts</p></li>
</ul>
<p>In all cases, an interface to work with blobs like this will be exported:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">interface</span> <span class="n">IBlobAccessToken</span> <span class="p">{</span>
  <span class="n">blobAccountUrl</span><span class="p">:</span> <span class="n">string</span><span class="p">;</span>
  <span class="n">sasToken</span><span class="p">:</span> <span class="n">string</span><span class="p">;</span>
  <span class="n">containerName</span><span class="p">:</span> <span class="n">string</span><span class="p">;</span>
  <span class="n">patientId</span><span class="p">:</span> <span class="n">string</span><span class="p">;</span> <span class="p">(</span><span class="n">optional</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>and a class will be defined with the possible functions that can be performed with the blob:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Injectable</span><span class="p">()</span>
<span class="n">export</span> <span class="k">class</span> <span class="nc">BlobStorage</span><span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="p">{</span><span class="o">...</span><span class="p">}</span>
</pre></div>
</div>
<p>With this, from the different sections of Health29 it will be possible to create the containers in the blob and store the relevant information.
An example of use would be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">constructor</span> <span class="o">...</span> <span class="p">(</span><span class="o">...</span><span class="p">,</span><span class="n">private</span> <span class="n">blob</span><span class="p">:</span> <span class="n">BlobStorageMedicalCareService</span><span class="p">,</span><span class="o">...</span><span class="p">)</span>
<span class="o">...</span>
<span class="n">this</span><span class="o">.</span><span class="n">blob</span><span class="o">.</span><span class="n">uploadToBlobStorage</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">accessToken</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">files</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">index1</span><span class="p">,</span> <span class="n">index2</span><span class="p">);</span>
</pre></div>
</div>
<p>In addition to this, the HTTP headers have to be configured to be able to use this service in the auth.interceptor.ts file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="k">if</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">indexOf</span><span class="p">(</span><span class="s1">&#39;https://blobgenomics.blob.core.windows.net/&#39;</span><span class="p">)</span><span class="o">!==-</span><span class="mi">1</span><span class="p">){</span>
  <span class="n">isExternalReq</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
  <span class="n">const</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">new</span> <span class="n">HttpHeaders</span><span class="p">({</span>
    <span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">:</span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Ocp-Apim-Subscription-Key&#39;</span><span class="p">:</span> <span class="s1">&#39;lXaW8+GnmQuHYVku3GWEjZnRhi9hv5u7v2kGvRiUQR6/PTlJuIZT+hyf+nUgLGTSpIToheyZ7oXyX34+q3s63g==&#39;</span>
  <span class="p">});</span>
  <span class="n">authReq</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">clone</span><span class="p">({</span> <span class="n">headers</span><span class="p">});</span><span class="o">//</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span>  <span class="s1">&#39;application/json&#39;</span>
<span class="p">}</span>

<span class="k">if</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">indexOf</span><span class="p">(</span><span class="s1">&#39;https://health29support.blob.core.windows.net/&#39;</span><span class="p">)</span><span class="o">!==-</span><span class="mi">1</span><span class="p">){</span>
  <span class="n">isExternalReq</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
  <span class="n">const</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">new</span> <span class="n">HttpHeaders</span><span class="p">({</span>
    <span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">:</span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Ocp-Apim-Subscription-Key&#39;</span><span class="p">:</span> <span class="s1">&#39;g/KX0iFgXuPQMHDDLWYDXJDihvPTMv9/Uyp2lsWGu81azji7i0oPh21R3vjnn1oDGIHjsYsRIEEuR5F8PFrbAw==&#39;</span>
  <span class="p">});</span>
  <span class="n">authReq</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">clone</span><span class="p">({</span> <span class="n">headers</span><span class="p">});</span><span class="o">//</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span>  <span class="s1">&#39;application/json&#39;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="other-services">
<h2>2.4.6. Other services<a class="headerlink" href="#other-services" title="Permalink to this headline">¶</a></h2>
<p>The <strong><a class="reference external" href="https://portal.azure.com/#&#64;foundation29outlook.onmicrosoft.com/resource/subscriptions/53348303-e009-4241-9ac7-a8e4465ece27/resourceGroups/phenotypeBot/providers/Microsoft.Web/sites/DiagnosisApi/appServices">DiagnosisApi</a></strong> is an App Service of Azure that is used for consulting the symptons of a diagnose.
To create it from azure you must create an <a class="reference external" href="https://docs.microsoft.com/en-US/azure/app-service/">App service of Azure</a>.</p>
<p>It is used in the webapp client establishing a REST communication:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="n">let</span> <span class="n">httpParams</span> <span class="o">=</span> <span class="n">new</span> <span class="n">HttpParams</span><span class="p">();</span>
<span class="n">hposStrins</span><span class="o">.</span><span class="n">forEach</span><span class="p">(</span><span class="nb">id</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="n">httpParams</span> <span class="o">=</span> <span class="n">httpParams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;symtomCodes&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">);</span>
<span class="p">});</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="n">this</span><span class="o">.</span><span class="n">subscription</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">this</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://diagnosisapi.azurewebsites.net/api/Consulting/GetSymptomsFromCodes&#39;</span><span class="p">,{</span><span class="n">params</span><span class="p">:</span> <span class="n">httpParams</span><span class="p">})</span>
  <span class="o">.</span><span class="n">subscribe</span><span class="p">(</span> <span class="p">(</span><span class="n">res</span> <span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  	 <span class="o">//</span> <span class="n">Get</span> <span class="n">the</span> <span class="n">symptoms</span> <span class="n">codes</span> <span class="n">OK</span>
  <span class="p">},</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
	<span class="o">//</span> <span class="n">Do</span> <span class="n">something</span> <span class="n">when</span> <span class="n">error</span>
<span class="p">}));</span>
</pre></div>
</div>
<p>And the configuration of the headers (auth.interceptor.ts) to use this service is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">indexOf</span><span class="p">(</span><span class="s1">&#39;https://diagnosisapi.azurewebsites.net/api/Consulting&#39;</span><span class="p">)</span><span class="o">!==-</span><span class="mi">1</span><span class="p">){</span>
  <span class="n">isExternalReq</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
  <span class="n">const</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">new</span> <span class="n">HttpHeaders</span><span class="p">({</span>
    <span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">:</span><span class="s1">&#39;*&#39;</span>
  <span class="p">});</span>
  <span class="n">authReq</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">clone</span><span class="p">({</span> <span class="n">headers</span><span class="p">});</span><span class="o">//</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span>  <span class="s1">&#39;application/json&#39;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the same way, we can access and use the <strong>Genomics Functions apps</strong>.
It is used in the webapp client establishing a REST communication:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">this</span><span class="o">.</span><span class="n">subscription</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">this</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;https://genomicservices.azurewebsites.net/api/exomize?code=p/aGykMRV8KiTfo8AXO8yDjHYdImgRjjasrGu8eaBVn7U75jf1DtmQ==&#39;</span><span class="p">,</span><span class="n">jsonfile</span><span class="p">)</span>
      <span class="o">.</span><span class="n">subscribe</span><span class="p">(</span> <span class="p">(</span><span class="n">res</span> <span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="o">.</span><span class="n">subscribe</span><span class="p">(</span> <span class="p">(</span><span class="n">res</span> <span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  	<span class="o">//</span> <span class="n">Result</span> <span class="n">of</span> <span class="n">exomize</span> <span class="n">function</span> <span class="n">OK</span>
  <span class="p">},</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
	<span class="o">//</span> <span class="n">Do</span> <span class="n">something</span> <span class="n">when</span> <span class="n">error</span>
<span class="p">}));</span>
</pre></div>
</div>
<p>And the configuration of the headers (auth.interceptor.ts) to use this functions is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">indexOf</span><span class="p">(</span><span class="s1">&#39;https://genomicservices.azurewebsites.net/api/exomize&#39;</span><span class="p">)</span><span class="o">!==-</span><span class="mi">1</span><span class="p">){</span>
  <span class="n">isExternalReq</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
  <span class="n">const</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">new</span> <span class="n">HttpHeaders</span><span class="p">({</span>
    <span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">:</span><span class="s1">&#39;*&#39;</span>
  <span class="p">});</span>
  <span class="n">authReq</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">clone</span><span class="p">({</span> <span class="n">headers</span><span class="p">});</span><span class="o">//</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span>  <span class="s1">&#39;application/json&#39;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="databases">
<h2>2.4.7. Databases<a class="headerlink" href="#databases" title="Permalink to this headline">¶</a></h2>
<p>The databases are created in Azure as <a class="reference external" href="https://docs.microsoft.com/en-US/azure/cosmos-db/">Azure Cosmos DB account</a>.To create it you just have to select in the marketplace: “Azure Cosmo db” and configure it.</p>
<p>As mentioned throughout the development of this document, there will be 4 databases: two for the test and development environments, and two for the production environment.
The structure of the databases of the two environments will be the same, so we have:</p>
<p style="text-align: center;">
	<img width="400px" src="../../_images/DDBB_Division.jpg">
</p><p>Each database will be composed of some collections that will be accessed from the Health29 platform server.</p>
<p>In the following sections we will explain how this connection between Health29 and Azure’s databases is made, and we will go deeper into each of them by explaining the structure and layout of the collections they contain in each case.</p>
<div class="section" id="databases-and-health29-communication">
<h3>2.4.7.1. Databases and health29 communication<a class="headerlink" href="#databases-and-health29-communication" title="Permalink to this headline">¶</a></h3>
<p>As indicated above, the communication is established using mongoose, so for each model or scheme in a database collection, we will have</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">mongoose</span> <span class="o">=</span> <span class="n">require</span> <span class="p">(</span><span class="s1">&#39;mongoose&#39;</span><span class="p">);</span>
<span class="n">const</span> <span class="p">{</span> <span class="n">conndbaccounts</span> <span class="p">}</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s1">&#39;../db_connect&#39;</span><span class="p">)</span>

<span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="p">{</span><span class="n">Schema</span> <span class="n">definition</span><span class="p">}</span>

<span class="n">module</span><span class="o">.</span><span class="n">exports</span> <span class="o">=</span> <span class="n">conndbaccounts</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="o">&lt;</span><span class="n">Collection</span> <span class="n">name</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="n">schema</span> <span class="n">name</span><span class="o">&gt;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="ddbb-accounts">
<h3>2.4.7.2. DDBB: Accounts<a class="headerlink" href="#ddbb-accounts" title="Permalink to this headline">¶</a></h3>
<p><strong>Alerts</strong>
In this collection are saved the notifications or alerts created by the administrator or super administrator profiles, indicating the group of users (receivers) to which they will be sent/displayed. It also includes fields to manage the language of the notification.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">AlertsSchema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
    <span class="n">groupId</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span><span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span><span class="s2">&quot;None&quot;</span><span class="p">},</span>
    <span class="nb">type</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span><span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">},</span>
    <span class="n">identifier</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span><span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">},</span>
    <span class="n">translatedName</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Object</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="p">[]},</span>
    <span class="n">launchDate</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Date</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Date</span><span class="o">.</span><span class="n">now</span><span class="p">},</span>
    <span class="n">endDate</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Date</span><span class="p">},</span>
    <span class="n">url</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span><span class="n">Object</span><span class="p">,</span> <span class="n">default</span><span class="p">:[]},</span>
	<span class="n">role</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">enum</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;SuperAdmin&#39;</span><span class="p">,</span> <span class="s1">&#39;Admin&#39;</span><span class="p">,</span> <span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="s1">&#39;Clinical&#39;</span><span class="p">,</span> <span class="s1">&#39;Lab&#39;</span><span class="p">],</span> <span class="n">default</span><span class="p">:</span> <span class="s1">&#39;User&#39;</span><span class="p">},</span>
    <span class="n">color</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span><span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">},</span>
    <span class="n">logo</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span><span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">},</span>
    <span class="n">importance</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span><span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">},</span>
    <span class="n">receiver</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span><span class="n">Object</span><span class="p">,</span> <span class="n">default</span><span class="p">:[]},</span>
	<span class="n">createdBy</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Schema</span><span class="o">.</span><span class="n">Types</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="s2">&quot;Group&quot;</span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
<p><strong>Bot</strong>
This collection stores the information exchanged between the bot and a user when using the Healthbot direct question scenario.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">BotSchema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
	<span class="n">lang</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span><span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">},</span>
    <span class="n">data</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Object</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="p">[]},</span>
	<span class="n">date</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Date</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Date</span><span class="o">.</span><span class="n">now</span><span class="p">},</span>
	<span class="n">curatedBy</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span><span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">},</span>
	<span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">createdBy</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Schema</span><span class="o">.</span><span class="n">Types</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="s2">&quot;Group&quot;</span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
<p><strong>Group</strong>
In this collection, the patient groups available at Health29 are stored.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">GroupSchema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
	<span class="n">name</span><span class="p">:</span> <span class="p">{</span>
		<span class="nb">type</span><span class="p">:</span> <span class="n">String</span>
  	<span class="p">},</span>
	<span class="n">subscription</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">email</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">defaultLang</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="s1">&#39;en&#39;</span><span class="p">},</span>
	<span class="n">phenotype</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Object</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="p">[]},</span>
	<span class="n">medications</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Object</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="p">[]}</span>
<span class="p">})</span>
</pre></div>
</div>
<p><strong>Lab</strong>
Same as the last one but with the labs.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">LabSchema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
	<span class="n">name</span><span class="p">:</span> <span class="p">{</span>
		<span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
		<span class="n">index</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
		<span class="n">unique</span><span class="p">:</span> <span class="n">true</span>
  	<span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
<p><strong>Lang</strong>
There will be one entry in this collection for each language you want to use on the Health29 platform</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">LangSchema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
	<span class="n">name</span><span class="p">:</span> <span class="p">{</span>	<span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>	<span class="n">unique</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>	<span class="n">required</span><span class="p">:</span> <span class="n">true</span> <span class="p">},</span>
	<span class="n">code</span><span class="p">:</span> <span class="p">{</span>	<span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>	<span class="n">index</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>	<span class="n">unique</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>	<span class="n">required</span><span class="p">:</span> <span class="n">true</span> <span class="p">}</span>
<span class="p">},</span>
<span class="p">{</span> <span class="n">versionKey</span><span class="p">:</span> <span class="n">false</span> <span class="o">//</span> <span class="n">You</span> <span class="n">should</span> <span class="n">be</span> <span class="n">aware</span> <span class="n">of</span> <span class="n">the</span> <span class="n">outcome</span> <span class="n">after</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">false</span>
<span class="p">})</span>
</pre></div>
</div>
<p><strong>Patient</strong>
In this collection the data of the patients registered in the platform are stored.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">SiblingSchema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
	<span class="n">gender</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">affected</span><span class="p">:</span> <span class="n">String</span> <span class="o">//</span><span class="n">affected</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">enum</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;yes&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">]}</span> <span class="n">si</span> <span class="n">hacemos</span> <span class="n">validacion</span> <span class="n">de</span> <span class="n">que</span> <span class="n">no</span> <span class="n">pueda</span> <span class="n">ser</span> <span class="n">null</span><span class="p">,</span> <span class="n">igual</span> <span class="n">poner</span> <span class="n">el</span> <span class="n">enum</span>
<span class="p">})</span>

<span class="n">const</span> <span class="n">ParentSchema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
	<span class="n">highEducation</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">profession</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">relationship</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">nameCaregiver</span><span class="p">:</span> <span class="n">String</span>
<span class="p">})</span>

<span class="n">const</span> <span class="n">PatientSchema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
	<span class="n">patientName</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">surname</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">birthDate</span><span class="p">:</span> <span class="n">Date</span><span class="p">,</span>
	<span class="n">citybirth</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">provincebirth</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">countrybirth</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">street</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">postalCode</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">city</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">province</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">country</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">phone1</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">phone2</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">gender</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">siblings</span><span class="p">:</span> <span class="p">[</span><span class="n">SiblingSchema</span><span class="p">],</span>
	<span class="n">parents</span><span class="p">:</span> <span class="p">[</span><span class="n">ParentSchema</span><span class="p">],</span>
	<span class="n">createdBy</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Schema</span><span class="o">.</span><span class="n">Types</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="s2">&quot;User&quot;</span><span class="p">},</span>
	<span class="n">death</span><span class="p">:</span> <span class="n">Date</span><span class="p">,</span>
	<span class="n">notes</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
	<span class="n">answers</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Object</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="p">[]},</span>
	<span class="n">subscriptionToGroupAlerts</span><span class="p">:{</span><span class="nb">type</span><span class="p">:</span><span class="n">Boolean</span><span class="p">,</span><span class="n">default</span><span class="p">:</span><span class="n">true</span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
<p><strong>Prom</strong>
The datapoints associated with a group of patients are stored here.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">PromSchema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
	<span class="n">name</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">responseType</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">question</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">hideQuestion</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">false</span><span class="p">},</span>
	<span class="n">marginTop</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">false</span><span class="p">},</span>
	<span class="n">values</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span>
	<span class="n">section</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Schema</span><span class="o">.</span><span class="n">Types</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="s2">&quot;PromSection&quot;</span><span class="p">},</span>
	<span class="n">order</span><span class="p">:</span><span class="n">Number</span><span class="p">,</span>
	<span class="n">periodicity</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
	<span class="n">isRequired</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">false</span><span class="p">},</span>
	<span class="n">enabled</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">false</span><span class="p">},</span>
	<span class="n">createdBy</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Schema</span><span class="o">.</span><span class="n">Types</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="s2">&quot;Group&quot;</span><span class="p">},</span>
	<span class="n">width</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">hpo</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">relatedTo</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Schema</span><span class="o">.</span><span class="n">Types</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="s2">&quot;PromSchema&quot;</span><span class="p">},</span>
	<span class="n">disableDataPoints</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Schema</span><span class="o">.</span><span class="n">Types</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="s2">&quot;PromSchema&quot;</span><span class="p">}</span>

<span class="p">})</span>
</pre></div>
</div>
<p><strong>PromSection</strong>
Each of the above datapoints is encapsulated within a section. The different sections or groupings of datapoints that can appear on the platform for each group of patients are saved in this collection.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">PromSectionSchema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
	<span class="n">name</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">description</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">enabled</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">true</span><span class="p">},</span>
	<span class="n">order</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
	<span class="n">createdBy</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Schema</span><span class="o">.</span><span class="n">Types</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="s2">&quot;Group&quot;</span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
<p><strong>Qna</strong>
To access the information contained in qnaMaker, it is necessary to identify each of the databases created there, according to language and patient group. This collection contains this identifying information.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">QnaSchema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
	<span class="n">group</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">required</span><span class="p">:</span> <span class="n">true</span><span class="p">},</span>
	<span class="n">knowledgeBaseID</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">required</span><span class="p">:</span> <span class="n">true</span><span class="p">},</span>
	<span class="n">lang</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">required</span><span class="p">:</span> <span class="n">true</span><span class="p">},</span>
	<span class="n">categories</span><span class="p">:{</span><span class="nb">type</span><span class="p">:</span><span class="n">Object</span><span class="p">,</span><span class="n">default</span><span class="p">:[]}</span>
<span class="p">})</span>
</pre></div>
</div>
<p><strong>StructureProms</strong>
Again this collection provides functionality to work with the different datapoints of a group of patients. It stores the structure of the datapoints for each patient group for each available language.
Highlight here the data field: it contains a lot of information, for example for the duchenne patient group it is 2,000 lines of a JSON. It has been done this way because we have a section to translate, and so we load everything in the language of the patient</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">StructurePromSchema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
	<span class="n">data</span><span class="p">:</span> <span class="n">Schema</span><span class="o">.</span><span class="n">Types</span><span class="o">.</span><span class="n">Mixed</span><span class="p">,</span>
	<span class="n">lang</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">required</span><span class="p">:</span> <span class="n">true</span><span class="p">},</span>
	<span class="n">createdBy</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Schema</span><span class="o">.</span><span class="n">Types</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="s2">&quot;Group&quot;</span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
<p><strong>Support</strong>
In this collection is stored the information related to the requests made by users to the support of the platform.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">SupportSchema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
	<span class="n">platform</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">subject</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">description</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">status</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="s1">&#39;unread&#39;</span><span class="p">},</span>
	<span class="n">statusDate</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Date</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Date</span><span class="o">.</span><span class="n">now</span><span class="p">},</span>
	<span class="n">files</span><span class="p">:</span> <span class="n">Object</span><span class="p">,</span>
	<span class="n">date</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Date</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Date</span><span class="o">.</span><span class="n">now</span><span class="p">},</span>
	<span class="n">createdBy</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Schema</span><span class="o">.</span><span class="n">Types</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="s2">&quot;User&quot;</span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
<p><strong>UserAlerts</strong>
This collection is related to the “Alerts” collection. The content of this one will be generated from the previous one, according to the receiver and the launch date of the alert.
The information about the notifications and their status for each patient in the platform will be stored here.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">UseralertsSchema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
    <span class="n">alertId</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span><span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">},</span>
    <span class="n">patientId</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span><span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">},</span>
    <span class="n">state</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span><span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span><span class="s2">&quot;Not read&quot;</span><span class="p">},</span>
    <span class="n">snooze</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span><span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span><span class="s2">&quot;1&quot;</span><span class="p">},</span>
    <span class="n">showDate</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Date</span><span class="p">},</span>
    <span class="n">launch</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">false</span><span class="p">},</span>
    <span class="n">createdBy</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Schema</span><span class="o">.</span><span class="n">Types</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="s2">&quot;Group&quot;</span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
<p><strong>User</strong>
Analogous to patient collection but with user data.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>const SiblingSchema = Schema({
	gender: String,
	affected: { type: String, enum: [&#39;yes&#39;, &#39;no&#39;]}
})

const ParentSchema = Schema({
	highEducation: String,
	profession: String
})

const UserSchema = Schema({
	email: {
		type: String,
		index: true,
		trim: true,
		lowercase: true,
		unique: true,
		required: &#39;Email address is required&#39;,
        match: [/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/, &#39;Please fill a valid email address&#39;]
    },
	password: { type: String, select: false, required: true, minlength: [8,&#39;Password too short&#39;]},
	role: { type: String, required: true, enum: [&#39;SuperAdmin&#39;, &#39;Admin&#39;, &#39;User&#39;, &#39;Clinical&#39;, &#39;Lab&#39;], default: &#39;User&#39;},
	group: { type: String, required: true, default: &#39;None&#39;},
	confirmed: {type: Boolean, default: false},
	confirmationCode: String,
	signupDate: {type: Date, default: Date.now},
	lastLogin: {type: Date, default: null},
	userName: String,
	loginAttempts: { type: Number, required: true, default: 0 },
  	lockUntil: { type: Number },
	lang: { type: String, required: true, default: &#39;en&#39;},
	randomCodeRecoverPass: String,
	dateTimeRecoverPass: Date,
	massunit: { type: String, required: true, default: &#39;kg&#39;},
	lengthunit: { type: String, required: true, default: &#39;cm&#39;},
	blockedaccount: {type: Boolean, default: false},
	permissions: {type: Object, default: {}},
	modules: {type: Object, default: []},
	platform: {type: String, default: &#39;&#39;},
	authyId:{type:String,default:null},
	authyDeviceId:{type:Object,default:[]},
	phone: String,
})
</pre></div>
</div>
</div>
<div class="section" id="ddbb-data">
<h3>2.4.7.3. DDBB: Data<a class="headerlink" href="#ddbb-data" title="Permalink to this headline">¶</a></h3>
<p>In all the collections of this database, the information entered by the patient in the Health29 platform will be saved. Thus, for each of the sections that appear in it, the information relating to it will be saved in the corresponding collection of this database.</p>
<p>ClinicalTrials</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">ClinicalTrialSchema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
	<span class="n">nameClinicalTrial</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">takingClinicalTrial</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">drugName</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">center</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">date</span><span class="p">:</span> <span class="n">Date</span><span class="p">,</span>
	<span class="n">createdBy</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Schema</span><span class="o">.</span><span class="n">Types</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="s2">&quot;Patient&quot;</span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
<p>Diagnosis</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">DiagnosisSchema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
	<span class="n">hasDiagnosis</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">false</span><span class="p">},</span>
	<span class="n">previousDiagnosis</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">null</span><span class="p">},</span>
	<span class="n">identifiedGene</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">null</span><span class="p">},</span>
	<span class="n">evaluation</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">notes</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
	<span class="n">infoGenesAndConditionsExomizer</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Object</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="p">[]},</span>
	<span class="n">infoGenesAndConditionsPhenolyzer</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Object</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="p">[]},</span>
	<span class="n">relatedConditions</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Object</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="p">[]},</span>
	<span class="n">hasVcf</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">false</span><span class="p">},</span>
	<span class="n">createdBy</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Schema</span><span class="o">.</span><span class="n">Types</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="s2">&quot;Patient&quot;</span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
<p>Genotype</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">GenotypeSchema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
	<span class="n">inputType</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">null</span><span class="p">},</span>
	<span class="n">date</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Date</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Date</span><span class="o">.</span><span class="n">now</span><span class="p">},</span>
	<span class="n">data</span><span class="p">:</span> <span class="n">Object</span><span class="p">,</span>
	<span class="n">createdBy</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Schema</span><span class="o">.</span><span class="n">Types</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="s2">&quot;Patient&quot;</span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
<p>HeightHistory</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">HeightHistorySchema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
	<span class="n">dateTime</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Date</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Date</span><span class="o">.</span><span class="n">now</span><span class="p">},</span>
	<span class="n">value</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">technique</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">createdBy</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Schema</span><span class="o">.</span><span class="n">Types</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="s2">&quot;Patient&quot;</span><span class="p">}</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="n">versionKey</span><span class="p">:</span> <span class="n">false</span> <span class="o">//</span> <span class="n">You</span> <span class="n">should</span> <span class="n">be</span> <span class="n">aware</span> <span class="n">of</span> <span class="n">the</span> <span class="n">outcome</span> <span class="n">after</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">false</span>
<span class="p">})</span>
</pre></div>
</div>
<p>Height</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">HeightSchema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
	<span class="n">dateTime</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Date</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Date</span><span class="o">.</span><span class="n">now</span><span class="p">},</span>
	<span class="n">value</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">technique</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">createdBy</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Schema</span><span class="o">.</span><span class="n">Types</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="s2">&quot;Patient&quot;</span><span class="p">}</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="n">versionKey</span><span class="p">:</span> <span class="n">false</span> <span class="o">//</span> <span class="n">You</span> <span class="n">should</span> <span class="n">be</span> <span class="n">aware</span> <span class="n">of</span> <span class="n">the</span> <span class="n">outcome</span> <span class="n">after</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">false</span>
<span class="p">})</span>
</pre></div>
</div>
<p>Medicalcare</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">MedicalCareSchema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
	<span class="n">date</span><span class="p">:</span> <span class="n">Date</span><span class="p">,</span>
	<span class="n">data</span><span class="p">:</span> <span class="n">Object</span><span class="p">,</span>
	<span class="n">createdBy</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Schema</span><span class="o">.</span><span class="n">Types</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="s2">&quot;Patient&quot;</span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
<p>Medication</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">MedicationSchema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
	<span class="n">drug</span><span class="p">:</span> <span class="n">Object</span><span class="p">,</span>
	<span class="n">dose</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">startDate</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Date</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Date</span><span class="o">.</span><span class="n">now</span><span class="p">},</span>
	<span class="n">endDate</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Date</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">null</span><span class="p">},</span>
	<span class="n">sideEffects</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Object</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">null</span><span class="p">},</span>
	<span class="n">adverseEffects</span><span class="p">:</span> <span class="n">Object</span><span class="p">,</span>
	<span class="n">compassionateUse</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
	<span class="n">vaccinations</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">vaccinationDate</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Date</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Date</span><span class="o">.</span><span class="n">now</span><span class="p">},</span>
	<span class="n">notes</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
	<span class="n">freesideEffects</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
	<span class="n">createdBy</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Schema</span><span class="o">.</span><span class="n">Types</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="s2">&quot;Patient&quot;</span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
<p>Othermedications</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">OtherMedicationSchema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
	<span class="n">name</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">dose</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">startDate</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Date</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Date</span><span class="o">.</span><span class="n">now</span><span class="p">},</span>
	<span class="n">endDate</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Date</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">null</span><span class="p">},</span>
	<span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">notes</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">createdBy</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Schema</span><span class="o">.</span><span class="n">Types</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="s2">&quot;Patient&quot;</span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
<p>Patient-proms</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">PatientPromSchema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
	<span class="n">data</span><span class="p">:</span> <span class="n">Schema</span><span class="o">.</span><span class="n">Types</span><span class="o">.</span><span class="n">Mixed</span><span class="p">,</span>
	<span class="n">date</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Date</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Date</span><span class="o">.</span><span class="n">now</span><span class="p">},</span>
	<span class="n">definitionPromId</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Schema</span><span class="o">.</span><span class="n">Types</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="s2">&quot;PromSchema&quot;</span><span class="p">},</span>
	<span class="n">createdBy</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Schema</span><span class="o">.</span><span class="n">Types</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="s2">&quot;Patient&quot;</span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
<p>PhenotypeHistory</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">PhenotypeHistorySchema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
	<span class="n">validator_id</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">null</span><span class="p">},</span>
	<span class="n">validated</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">false</span><span class="p">},</span>
	<span class="n">inputType</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">null</span><span class="p">},</span>
	<span class="n">date</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Date</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Date</span><span class="o">.</span><span class="n">now</span><span class="p">},</span>
	<span class="n">data</span><span class="p">:</span> <span class="n">Object</span><span class="p">,</span>
	<span class="n">createdBy</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Schema</span><span class="o">.</span><span class="n">Types</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="s2">&quot;Patient&quot;</span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
<p>Phenotype</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">PhenotypeSchema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
	<span class="n">validator_id</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">null</span><span class="p">},</span>
	<span class="n">validated</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">false</span><span class="p">},</span>
	<span class="n">inputType</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">null</span><span class="p">},</span>
	<span class="n">date</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Date</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Date</span><span class="o">.</span><span class="n">now</span><span class="p">},</span>
	<span class="n">data</span><span class="p">:</span> <span class="n">Object</span><span class="p">,</span>
	<span class="n">createdBy</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Schema</span><span class="o">.</span><span class="n">Types</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="s2">&quot;Patient&quot;</span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
<p>Seizures</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">SeizuresSchema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
	<span class="n">disparadores</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Object</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="p">[]},</span>
	<span class="n">disparadorEnfermo</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
	<span class="n">disparadorOtro</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
	<span class="n">disparadorNotas</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
	<span class="n">descripcion</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Object</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="p">[]},</span>
	<span class="n">descripcionRigidez</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
	<span class="n">descripcionContraccion</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
	<span class="n">descripcionOtro</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
	<span class="n">descipcionNotas</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
	<span class="n">postCrisis</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Object</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="p">[]},</span>
	<span class="n">postCrisisOtro</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
	<span class="n">postCrisisNotas</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
	<span class="n">estadoAnimo</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
	<span class="n">estadoConsciencia</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
	<span class="n">duracion</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Object</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="p">{</span><span class="n">hours</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">minutes</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">seconds</span><span class="p">:</span><span class="mi">0</span><span class="p">}},</span>
	<span class="nb">type</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">null</span><span class="p">},</span>
	<span class="n">start</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Date</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">null</span><span class="p">},</span>
	<span class="n">end</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Date</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">null</span><span class="p">},</span>
	<span class="n">GUID</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
	<span class="n">title</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
	<span class="n">color</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Object</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="p">{}},</span>
	<span class="n">actions</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Object</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="p">[]},</span>
	<span class="n">createdBy</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Schema</span><span class="o">.</span><span class="n">Types</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="s2">&quot;Patient&quot;</span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
<p>Social info</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">SocialInfoSchema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
	<span class="n">education</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">completedEducation</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">currentEducation</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">work</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">hoursWork</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">profession</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">livingSituation</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span>
	<span class="n">support</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span>
	<span class="n">sports</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span>
	<span class="n">interests</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span>
	<span class="n">moreInterests</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">createdBy</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Schema</span><span class="o">.</span><span class="n">Types</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="s2">&quot;Patient&quot;</span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
<p>Vaccinations</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">VaccinationSchema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
	<span class="n">name</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">date</span><span class="p">:</span> <span class="n">Date</span><span class="p">,</span>
	<span class="n">createdBy</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Schema</span><span class="o">.</span><span class="n">Types</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="s2">&quot;Patient&quot;</span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
<p>WeightHistory</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">WeightHistorySchema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
	<span class="n">dateTime</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Date</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Date</span><span class="o">.</span><span class="n">now</span><span class="p">},</span>
	<span class="n">value</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">createdBy</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Schema</span><span class="o">.</span><span class="n">Types</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="s2">&quot;Patient&quot;</span><span class="p">}</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="n">versionKey</span><span class="p">:</span> <span class="n">false</span> <span class="o">//</span> <span class="n">You</span> <span class="n">should</span> <span class="n">be</span> <span class="n">aware</span> <span class="n">of</span> <span class="n">the</span> <span class="n">outcome</span> <span class="n">after</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">false</span>
<span class="p">})</span>
</pre></div>
</div>
<p>Weight</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">WeightSchema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
	<span class="n">dateTime</span><span class="p">:</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="n">Date</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Date</span><span class="o">.</span><span class="n">now</span><span class="p">},</span>
	<span class="n">value</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="n">createdBy</span><span class="p">:</span> <span class="p">{</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Schema</span><span class="o">.</span><span class="n">Types</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="s2">&quot;Patient&quot;</span><span class="p">}</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="n">versionKey</span><span class="p">:</span> <span class="n">false</span> <span class="o">//</span> <span class="n">You</span> <span class="n">should</span> <span class="n">be</span> <span class="n">aware</span> <span class="n">of</span> <span class="n">the</span> <span class="n">outcome</span> <span class="n">after</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">false</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
<div class="section" id="collections-relationship">
<h3>2.4.7.4. Collections relationship<a class="headerlink" href="#collections-relationship" title="Permalink to this headline">¶</a></h3>
<p>The following diagram shows a summary of the relationships between the different database collections for each environment:</p>
<p style="text-align: center;">
	<img width="800px" src="../../_images/ddbb_relationship.jpg">
</p></div>
</div>
<div class="section" id="multilanguage">
<h2>2.4.8. Multilanguage<a class="headerlink" href="#multilanguage" title="Permalink to this headline">¶</a></h2>
<p>The Health29 platform has the option of being displayed in several languages for the user. In particular, it is implemented for English, Spanish and Dutch.</p>
<p>To achieve this different implementations will be made in the client and the server of the webapp.</p>
<div class="section" id="multilanguage-in-client">
<h3>2.4.8.1. Multilanguage in client<a class="headerlink" href="#multilanguage-in-client" title="Permalink to this headline">¶</a></h3>
<p>On the one hand, the client uses the <strong><a class="reference external" href="https://www.npmjs.com/package/&#64;ngx-translate/core">ngx-translate</a> library</strong>.
For that, version 9.0.2 of the core has been installed in the project:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">npm</span> <span class="n">install</span> <span class="nd">@ngx</span><span class="o">-</span><span class="n">translate</span><span class="o">/</span><span class="n">core</span><span class="o">@^</span><span class="mf">9.0</span><span class="o">.</span><span class="mi">2</span> <span class="o">--</span><span class="n">save</span>
</pre></div>
</div>
<p>And, in addition, version 2.0.1 of the http-loader is used:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">npm</span> <span class="n">install</span> <span class="nd">@ngx</span><span class="o">-</span><span class="n">translate</span><span class="o">/</span><span class="n">http</span><span class="o">-</span><span class="n">loader</span> <span class="o">--</span><span class="n">save</span>
</pre></div>
</div>
<p>To use it, you should configure app.module.ts:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="p">{</span> <span class="n">TranslateModule</span><span class="p">,</span> <span class="n">TranslateLoader</span> <span class="p">}</span> <span class="kn">from</span> <span class="s1">&#39;@ngx-translate/core&#39;</span><span class="p">;</span>
<span class="kn">import</span> <span class="p">{</span> <span class="n">TranslateHttpLoader</span> <span class="p">}</span> <span class="kn">from</span> <span class="s1">&#39;@ngx-translate/http-loader&#39;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">function</span> <span class="n">createTranslateLoader</span><span class="p">(</span><span class="n">http</span><span class="p">:</span> <span class="n">HttpClient</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">new</span> <span class="n">TranslateHttpLoader</span><span class="p">(</span><span class="n">http</span><span class="p">,</span> <span class="n">environment</span><span class="o">.</span><span class="n">api</span><span class="o">+</span><span class="s1">&#39;/assets/i18n/&#39;</span><span class="p">,</span> <span class="s1">&#39;.json&#39;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@NgModule</span><span class="p">({</span>
   <span class="p">[</span><span class="o">...</span><span class="p">]</span>
   <span class="n">imports</span><span class="p">:</span> <span class="p">[</span>
         <span class="o">...</span>
       <span class="n">TranslateModule</span><span class="o">.</span><span class="n">forRoot</span><span class="p">({</span>
               <span class="n">loader</span><span class="p">:</span> <span class="p">{</span>
                   <span class="n">provide</span><span class="p">:</span> <span class="n">TranslateLoader</span><span class="p">,</span>
                   <span class="n">useFactory</span><span class="p">:</span> <span class="p">(</span><span class="n">createTranslateLoader</span><span class="p">),</span>
                   <span class="n">deps</span><span class="p">:</span> <span class="p">[</span><span class="n">HttpClient</span><span class="p">]</span>
                 <span class="p">}</span>
           <span class="p">}),</span>
         <span class="o">...</span>
   <span class="p">]</span>
   <span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="p">})</span>
</pre></div>
</div>
<p>Furthermore, it is included in shared.module.ts:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="p">{</span> <span class="n">TranslateModule</span> <span class="p">}</span> <span class="kn">from</span> <span class="s1">&#39;@ngx-translate/core&#39;</span><span class="p">;</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="nd">@NgModule</span><span class="p">({</span>
    <span class="n">exports</span><span class="p">:</span> <span class="p">[</span>
        <span class="o">...</span>
        <span class="n">TranslateModule</span><span class="p">,</span>
        <span class="o">...</span>
    <span class="p">],</span>
    <span class="n">imports</span><span class="p">:</span> <span class="p">[</span>
        <span class="o">...</span>
        <span class="n">TranslateModule</span>

    <span class="p">],</span>
    <span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="p">})</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span>
</pre></div>
</div>
<p>And it will also be included in the module file of each component that is going to use this service in the same way, and in the .ts file of the component the translation service will be included:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="kn">import</span> <span class="p">{</span> <span class="n">TranslateService</span> <span class="p">}</span> <span class="kn">from</span> <span class="s1">&#39;@ngx-translate/core&#39;</span><span class="p">;</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="n">constructor</span><span class="p">(</span><span class="o">...</span><span class="p">,</span><span class="n">public</span> <span class="n">translate</span><span class="p">:</span> <span class="n">TranslateService</span><span class="p">,</span><span class="o">...</span><span class="p">){</span><span class="o">...</span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">this</span><span class="o">.</span><span class="n">translate</span><span class="o">.</span><span class="n">instant</span><span class="p">(</span><span class="s2">&quot;JSON_key1.JSON_key2&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, the service lang.service.ts has been created to implement the load function of the different languages available in the platform: “loadDataJson(lang:string)”</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">this</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">api</span><span class="o">+</span><span class="s1">&#39;/assets/i18n/&#39;</span><span class="o">+</span><span class="n">lang</span><span class="o">+</span><span class="s1">&#39;.json&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This function will be in charge of obtaining the information of the different JSON files for each language, located in scr/assets/i18n:</p>
<p style="text-align: center;">
  <img width="400px" src="../../_images/Multilanguage_assets.png">
</p><p>This function will be called when the user changes the language of the platform.</p>
<p>On the other hand, it has already been commented throughout this document that an Azure translation service is used for certain functions: <strong>the cognitive service Translator text</strong>. This has been explained in section 2.4.3.3. of this document at code level and in section 2.3.3.3. at component level.</p>
</div>
<div class="section" id="multilanguage-in-server">
<h3>2.4.8.2. Multilanguage in server<a class="headerlink" href="#multilanguage-in-server" title="Permalink to this headline">¶</a></h3>
<p>On the server, on the one hand you use <strong><a class="reference external" href="https://www.npmjs.com/package/&#64;k3rn31p4nic/google-translate-api">google-translate-api</a></strong>. It will be used in the superadmin language controller (controllers/superadmin/langs.js) to manage new languages.</p>
<p>On the other hand, <strong>different views</strong> have been implemented (one for each language in which we want to use the health29 platform) which will be selected according to the language information provided by the customer in their requests.</p>
</div>
</div>
<div class="section" id="second-factor-autenthication">
<h2>2.4.9. Second factor autenthication<a class="headerlink" href="#second-factor-autenthication" title="Permalink to this headline">¶</a></h2>
<p>The 2FA was incorporated in Health29 for the login on the platform of certain groups of patients.</p>
<p>Initially, an analysis was made of the different options that could be used for implementation, concluding in Authy.
Authy has the best combination of compatibility, usability, security and reliability. platforms including iOS, Android, Windows, Mac and Chrome, and has PIN and biometric protection for the application. Authy includes a secure cloud backup option, which makes it easy to use on multiple devices and makes your tokens easy to restore if you lose or replace your phone.</p>
<p>If you lose your phone, you lose access to your authentication application. To solve this problem, most authentication applications offer cloud-based backups (although security experts tend to recommend against using this feature), and some authentication application manufacturers are better at explaining how (or if) they encrypt these backups. Authy is the only application we tested that offers two security features that assist in account recovery: an encrypted cloud backup and support for a secondary device.</p>
<p>You can also install Authy on a secondary device, such as a computer or tablet, and use that device along with backups to recover your account in case you lose your phone. Authy calls this feature “multi-device”. Once you add the second device, Authy recommends that you disable the feature so that another person cannot add another device to take control of your account (Authy will continue to work on both devices). With backups and multi-device enabled, your tokens are synchronized across all devices where Authy is installed.</p>
<p>You can block the Authy application behind a PIN or biometric identification, such as a fingerprint or facial scan. If your phone is already blocked in this way (and it should be), this additional step is not necessary, but it’s a good touch if you want to use a different PIN for added security.</p>
<p>In particular, the Authy service we are using is accessed from <a class="reference external" href="https://www.twilio.com/login">the Twilio console</a>. The project was created: 2FA Project and the application Health29-Duchenne. From this portal it is possible to configure the screen to be shown to the users, the options to be worked with, and also to manage the current users.</p>
<p>For the implementation the version 1.4.0 of <a class="reference external" href="https://www.npmjs.com/package/authy">authy</a> has been used and is added to the code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">authy</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s1">&#39;authy&#39;</span><span class="p">)(</span><span class="n">APIKEY</span><span class="p">);</span>
</pre></div>
</div>
<p>As mentioned above, the user’s model and controller have been modified:</p>
<ul class="simple">
<li><p>In the user model, the fields were added:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">authyId</span><span class="p">:{</span><span class="nb">type</span><span class="p">:</span><span class="n">String</span><span class="p">,</span><span class="n">default</span><span class="p">:</span><span class="n">null</span><span class="p">},</span>
	<span class="n">authyDeviceId</span><span class="p">:{</span><span class="nb">type</span><span class="p">:</span><span class="n">Object</span><span class="p">,</span><span class="n">default</span><span class="p">:[]},</span>
	<span class="n">phone</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</pre></div>
</div>
<p>To store the information on each user required for interaction with Authy.</p>
<ul class="simple">
<li><p>In the user’s controller, the registration and user login functions were updated, and a new one was created to update those that existed before the addition of the functionality.
In all the functions the group of patients to which the user belongs is checked in order to apply or not the authentication conditions.
For these tasks the Authy functions will be used: register_user, send_approval_request and check_approval_status.</p></li>
</ul>
</div>
</div>


           </div>

          </div>
          <footer>

    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">

        <a href="../Superadmin profile.html" class="btn btn-neutral float-right" title="3. Superadmin profile" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>


        <a href="Components.html" class="btn btn-neutral float-left" title="2.3. Level 3: Component" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>

    </div>


  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Foundation29

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.

</footer>

        </div>
      </div>

    </section>

  </div>



  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>






</body>
</html>
